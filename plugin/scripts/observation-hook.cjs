#!/usr/bin/env node
var p=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var S=p((Y,f)=>{var s=require("node:fs"),d=require("node:path"),m=require("node:os"),u=d.join(m.homedir(),".nebula-claude"),o=d.join(u,"credentials.json"),O=process.env.NEBULA_API_URL||"https://api.trynebula.ai";function h(){s.existsSync(u)||s.mkdirSync(u,{recursive:!0})}function L(){try{if(s.existsSync(o)){let e=JSON.parse(s.readFileSync(o,"utf-8"));if(e.apiKey)return e}}catch{}return null}function v(e){h();let t={apiKey:e,savedAt:new Date().toISOString(),apiUrl:O};s.writeFileSync(o,JSON.stringify(t,null,2))}function U(){try{s.existsSync(o)&&s.unlinkSync(o)}catch{}}async function K(e){return!e||typeof e!="string"||e.trim().length===0?{valid:!1,error:"API key must be a non-empty string"}:{valid:!0}}f.exports={SETTINGS_DIR:u,CREDENTIALS_FILE:o,loadCredentials:L,saveCredentials:v,clearCredentials:U,validateApiKey:K}});var N=p((W,g)=>{var c=require("node:fs"),y=require("node:path"),P=require("node:os"),{loadCredentials:b}=S(),a=y.join(P.homedir(),".nebula-claude"),i=y.join(a,"settings.json"),E={skipTools:["Read","Glob","Grep","TodoWrite","AskUserQuestion"],captureTools:["Edit","Write","Bash","Task"],maxProfileItems:5,debug:!1,injectProfile:!0};function k(){c.existsSync(a)||c.mkdirSync(a,{recursive:!0})}function w(){let e={...E};try{if(c.existsSync(i)){let t=c.readFileSync(i,"utf-8");Object.assign(e,JSON.parse(t))}}catch(t){console.error(`Settings: Failed to load ${i}: ${t.message}`)}return process.env.NEBULA_API_KEY&&(e.apiKey=process.env.NEBULA_API_KEY),process.env.NEBULA_SKIP_TOOLS&&(e.skipTools=process.env.NEBULA_SKIP_TOOLS.split(",").map(t=>t.trim())),process.env.NEBULA_DEBUG==="true"&&(e.debug=!0),e}function B(e){k();let t={...e};delete t.apiKey,c.writeFileSync(i,JSON.stringify(t,null,2))}function $(e){if(e.apiKey)return e.apiKey;if(process.env.NEBULA_API_KEY)return process.env.NEBULA_API_KEY;let t=b();if(t?.apiKey)return t.apiKey;throw new Error("NO_API_KEY")}function q(e,t){return t.skipTools.includes(e)?!1:t.captureTools&&t.captureTools.length>0?t.captureTools.includes(e):!0}function x(e,t,n){if(e.debug){let r=new Date().toISOString();console.error(n?`[${r}] ${t}: ${JSON.stringify(n)}`:`[${r}] ${t}`)}}g.exports={SETTINGS_DIR:a,SETTINGS_FILE:i,DEFAULT_SETTINGS:E,loadSettings:w,saveSettings:B,getApiKey:$,shouldCaptureTool:q,debugLog:x}});var _=p((Q,T)=>{async function D(){return new Promise((e,t)=>{let n="";process.stdin.setEncoding("utf8"),process.stdin.on("data",r=>{n+=r}),process.stdin.on("end",()=>{try{e(n.trim()?JSON.parse(n):{})}catch(r){t(new Error(`Failed to parse stdin JSON: ${r.message}`))}}),process.stdin.on("error",t),process.stdin.isTTY&&e({})})}function l(e){console.log(JSON.stringify(e))}function F(e=null){l(e?{hookSpecificOutput:{hookEventName:"SessionStart",additionalContext:e}}:{continue:!0,suppressOutput:!0})}function J(e){console.error(`Nebula: ${e}`),l({continue:!0,suppressOutput:!0})}T.exports={readStdin:D,writeOutput:l,outputSuccess:F,outputError:J}});var{loadSettings:j,debugLog:I}=N(),{readStdin:G,outputSuccess:A}=_();async function C(){let e=j();try{let t=await G(),n=t.session_id,r=t.tool_name;I(e,"PostToolUse",{sessionId:n,toolName:r}),A()}catch(t){I(e,"Error",{error:t.message}),A()}}C().catch(e=>{console.error(`Nebula fatal: ${e.message}`),process.exit(1)});
