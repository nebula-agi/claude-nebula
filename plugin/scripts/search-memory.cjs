#!/usr/bin/env node
var ce=Object.create;var L=Object.defineProperty;var le=Object.getOwnPropertyDescriptor;var ue=Object.getOwnPropertyNames;var de=Object.getPrototypeOf,me=Object.prototype.hasOwnProperty;var S=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports);var fe=(s,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of ue(e))!me.call(s,i)&&i!==t&&L(s,i,{get:()=>e[i],enumerable:!(o=le(e,i))||o.enumerable});return s};var x=(s,e,t)=>(t=s!=null?ce(de(s)):{},fe(e||!s||!s.__esModule?L(t,"default",{value:s,enumerable:!0}):t,s));var J=S(p=>{"use strict";Object.defineProperty(p,"__esModule",{value:!0});var O=(s=>(s.ENTITY="entity",s.RELATIONSHIP="relationship",s.COMMUNITY="community",s))(O||{}),y=class extends Error{constructor(s,e,t){super(s),this.statusCode=e,this.details=t,this.name="NebulaException"}},f=class extends y{constructor(s,e){super(s),this.cause=e,this.name="NebulaClientException"}},K=class extends y{constructor(s="Invalid API key"){super(s,401),this.name="NebulaAuthenticationException"}},U=class extends y{constructor(s="Rate limit exceeded"){super(s,429),this.name="NebulaRateLimitException"}},k=class extends y{constructor(s="Validation error",e){super(s,400),this.details=e,this.name="NebulaValidationException"}},pe=class extends y{constructor(s="Collection not found"){super(s,404),this.name="NebulaCollectionNotFoundException"}},A=class extends y{constructor(s,e="Resource"){super(`${e} not found: ${s}`,404),this.name="NebulaNotFoundException"}},z=class B{constructor(e={}){if(this.apiKey=e.apiKey,!this.apiKey)throw new f("API key is required. Pass it to the constructor or set NEBULA_API_KEY environment variable.");this.baseUrl=(e.baseUrl||"https://api.trynebula.ai").replace(/\/$/,""),this.timeout=e.timeout||3e4}setApiKey(e){this.apiKey=e}setBaseUrl(e){this.baseUrl=(e||this.baseUrl).replace(/\/$/,"")}setCorsProxy(e){}isApiKeySet(){return!!(this.apiKey&&this.apiKey.trim()!=="")}_isNebulaApiKey(e){let t=e||this.apiKey;if(!t)return!1;let o=t.split(".");if(o.length!==2)return!1;let[i,n]=o;return(i.startsWith("key_")||i.startsWith("neb_"))&&!!n&&n.length>0}_buildAuthHeaders(e=!0){let t={};return this._isNebulaApiKey()?t["X-API-Key"]=this.apiKey:t.Authorization=`Bearer ${this.apiKey}`,e&&(t["Content-Type"]="application/json"),t}_isRecord(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)}_unwrapResults(e){return this._isRecord(e)&&"results"in e?e.results:e}_unwrapResultsArray(e){let t=this._unwrapResults(e);return Array.isArray(t)?t:t==null?[]:[t]}_looksLikeMultimodalContent(e){return Array.isArray(e)?e.some(t=>this._isRecord(t)?typeof t.type=="string"||"data"in t||"s3_key"in t||"url"in t:!1):!1}_normalizeContentParts(e){return e.map(t=>typeof t=="string"?{type:"text",text:t}:this._isRecord(t)?typeof t.type=="string"?t:"s3_key"in t&&typeof t.s3_key=="string"?{type:"s3_ref",s3_key:t.s3_key,bucket:typeof t.bucket=="string"?t.bucket:void 0,media_type:typeof t.media_type=="string"?t.media_type:"application/octet-stream",filename:typeof t.filename=="string"?t.filename:void 0,size_bytes:typeof t.size_bytes=="number"?t.size_bytes:void 0}:"data"in t&&typeof t.data=="string"?{type:"file",data:t.data,media_type:typeof t.media_type=="string"?t.media_type:"application/octet-stream",filename:typeof t.filename=="string"?t.filename:void 0,duration_seconds:typeof t.duration_seconds=="number"?t.duration_seconds:void 0}:{type:"text",text:String(t)}:{type:"text",text:String(t)})}async _serializeContentAsText(e){if(this._looksLikeMultimodalContent(e)){let t=this._normalizeContentParts(e),o=await this._processContentParts(t);return JSON.stringify(o)}return typeof e=="object"&&e!==null?JSON.stringify(e):String(e??"")}async _serializeContentAsParts(e){if(!this._looksLikeMultimodalContent(e))return null;let t=this._normalizeContentParts(e);return await this._processContentParts(t)}async _makeRequest(e,t,o,i){let n=new URL(t,this.baseUrl);i&&Object.entries(i).forEach(([a,r])=>{r!=null&&(Array.isArray(r)?r.forEach(c=>{n.searchParams.append(a,String(c))}):n.searchParams.append(a,String(r)))});let l=this._buildAuthHeaders(!0),u=new AbortController,d=setTimeout(()=>u.abort(),this.timeout);try{let a=await fetch(n.toString(),{method:e,headers:l,body:o?JSON.stringify(o):void 0,signal:u.signal});if(clearTimeout(d),a.status===200||a.status===202)return await a.json();if(a.status===401)throw new K("Invalid API key");if(a.status===429)throw new U("Rate limit exceeded");if(a.status===400){let r=await a.json().catch(()=>({}));throw new k(r.message||"Validation error",r.details)}else if(a.status===422){let r=await a.json().catch(()=>({}));throw console.error("[SDK] 422 Validation error - Full details:"),console.error("  Status:",a.status),console.error("  Error data:",JSON.stringify(r,null,2)),console.error("  Message:",r.message),console.error("  Detail:",r.detail),new k(r.message||(typeof r.detail=="string"?r.detail:JSON.stringify(r.detail))||"Validation error",r)}else{let r=await a.json().catch(()=>({}));throw new y(r.message||`API error: ${a.status}`,a.status,r)}}catch(a){throw clearTimeout(d),a instanceof y?a:a instanceof Error&&a.name==="AbortError"?new f(`Request timed out after ${this.timeout} milliseconds`):a instanceof Error?new f(`Request failed: ${a.message}`,a):new f(`Request failed: ${String(a)}`)}}async createCollection(e){let t={name:e.name};e.description&&(t.description=e.description),e.metadata&&(t.metadata=e.metadata);let o=await this._makeRequest("POST","/v1/collections",t),i=o.results||o;return this._collectionFromDict(i)}async getCollection(e){let t=await this._makeRequest("GET",`/v1/collections/${e}`),o=t.results||t;return this._collectionFromDict(o)}async getCollectionByName(e){let t=await this._makeRequest("GET",`/v1/collections/name/${e}`),o=t.results||t;return this._collectionFromDict(o)}async listCollections(e){let t={limit:e?.limit??100,offset:e?.offset??0};e?.name!==void 0&&(t.name=e.name);let o=await this._makeRequest("GET","/v1/collections",void 0,t),i;return typeof o=="object"&&o!==null&&"results"in o?i=o.results:Array.isArray(o)?i=o:i=[o],i.map(n=>this._collectionFromDict(n))}async updateCollection(e){let t={};e.name!==void 0&&(t.name=e.name),e.description!==void 0&&(t.description=e.description),e.metadata!==void 0&&(t.metadata=e.metadata);let o=await this._makeRequest("POST",`/v1/collections/${e.collectionId}`,t),i=o.results||o;return this._collectionFromDict(i)}async deleteCollection(e){return await this._makeRequest("DELETE",`/v1/collections/${e}`),!0}async store(e,t,o={}){let i={...o,memory_type:"memory",timestamp:new Date().toISOString()},n={collection_id:t,raw_text:String(e||""),metadata:i,ingestion_mode:"fast"},l=await this._makeRequest("POST","/v1/memories",n),u=l?.results?.engram_id||l?.results?.id||l?.id||"",d=i.timestamp;return{id:String(u),memory_id:String(u),content:String(e||""),metadata:i,collection_ids:[t],created_at:d,updated_at:d}}async storeMemory(e,t){let o;if("collection_id"in e)o=e;else{let c=e;o={collection_id:c.collection_id||c.collectionId||"",content:c.content||"",role:c.role,memory_id:c.memory_id||c.memoryId||void 0,metadata:c.metadata||{}}}if(o.memory_id)return await this._appendToMemory(o.memory_id,o);if((o.role?"conversation":"document")==="conversation"){let c=[];if(o.content&&o.role){let w=await this._serializeContentAsParts(o.content)??await this._serializeContentAsText(o.content),v=o;c.push({content:w,role:o.role,metadata:o.metadata||{},...typeof v.authority=="number"?{authority:Number(v.authority)}:{}})}if(c.length===0)throw new f("Cannot create conversation without messages. Provide content and role.");let m={collection_id:o.collection_id,name:t||"Conversation",messages:c,metadata:o.metadata||{}},h=await this._makeRequest("POST","/v1/memories",m);if(h.results){let _=h.results.memory_id||h.results.id;if(!_)throw new f("Failed to create conversation: no id returned");return String(_)}throw new f("Failed to create conversation: invalid response format")}let n={...o.metadata};n.memory_type="memory";let l=o;if(typeof l.authority=="number"){let c=Number(l.authority);!Number.isNaN(c)&&c>=0&&c<=1&&(n.authority=c)}let u,d=await this._serializeContentAsParts(o.content);if(d)u={collection_id:o.collection_id,content_parts:d,metadata:n,ingestion_mode:"fast"};else if(Array.isArray(o.content)&&o.content.every(c=>typeof c=="string"))u={collection_id:o.collection_id,chunks:o.content,metadata:n,ingestion_mode:"fast"};else{let c=await this._serializeContentAsText(o.content);if(!c||c==='""'||c==="[]"||c==="{}")throw new f("Content is required for document memories");u={collection_id:o.collection_id,raw_text:c,metadata:n,ingestion_mode:"fast"}}let a=await this._makeRequest("POST","/v1/memories",u),r=a?.results?.engram_id||a?.results?.id||a?.id||"";return String(r||"")}async _appendToMemory(e,t){let o=t.collection_id,i=t.content,n=t.metadata;if(!o)throw new f("collection_id is required");let l={collection_id:o};if(Array.isArray(i))i.length>0&&typeof i[0]=="object"&&"content"in i[0]?l.messages=i:l.chunks=i;else if(typeof i=="string")l.raw_text=i;else throw new f("content must be a string, array of strings, or array of message objects");n&&(l.metadata=n);try{return await this._makeRequest("POST",`/v1/memories/${e}/append`,l),e}catch(u){throw u instanceof y&&u.statusCode===404?new A(e,"Memory"):u}}async storeMemories(e){let t=[],o={},i=[];for(let n of e)if(n.role){let l=n.memory_id||`__new__::${n.collection_id}`;o[l]||(o[l]=[]),o[l].push(n)}else i.push(n);for(let[n,l]of Object.entries(o)){let u=l[0].collection_id,d,a=[];for(let r of l){let m=await this._serializeContentAsParts(r.content)??await this._serializeContentAsText(r.content);if(typeof m=="string"){if(!m.trim())continue}else if(m.length===0)continue;let h=r;a.push({content:m,role:r.role,metadata:r.metadata||{},...typeof h.authority=="number"?{authority:Number(h.authority)}:{}})}if(!a.length)throw new f("Cannot create/append conversation without messages. Provide non-empty content.");if(n.startsWith("__new__::")){let r={collection_id:u,name:"Conversation",messages:a,metadata:{}},c=await this._makeRequest("POST","/v1/memories",r);if(c.results){if(d=c.results.memory_id||c.results.id||"",!d)throw new f("Failed to create conversation: no id returned")}else throw new f("Failed to create conversation: invalid response format")}else{d=n;let r={collection_id:u,content:a,memory_id:d,metadata:{}};await this._appendToMemory(d,r)}t.push(...Array(l.length).fill(String(d)))}for(let n of i)t.push(await this.storeMemory(n));return t}async delete(e){try{if(console.log("[SDK] delete() called with:",{memoryIds:e,type:typeof e,isArray:Array.isArray(e)}),typeof e=="string"){console.log("[SDK] Single deletion path for ID:",e);try{return await this._makeRequest("DELETE",`/v1/memories/${e}`),!0}catch{console.log("[SDK] Falling back to POST /v1/memories/delete with single ID");let t=await this._makeRequest("POST","/v1/memories/delete",e);return typeof t=="object"&&t.success!==void 0?t.success:!0}}else{console.log("[SDK] Batch deletion path for IDs:",e),console.log("[SDK] Sending POST request with body:",e);let t=await this._makeRequest("POST","/v1/memories/delete",e);return console.log("[SDK] Batch deletion response:",t),t}}catch(t){throw console.error("[SDK] Delete error:",t),t instanceof Error?t:new f(`Unknown error: ${String(t)}`)}}async deleteChunk(e){try{return await this._makeRequest("DELETE",`/v1/chunks/${e}`),!0}catch(t){throw t instanceof y&&t.statusCode===404?new A(e,"Chunk"):t}}async updateChunk(e,t,o){let i={content:t};o!==void 0&&(i.metadata=o);try{return await this._makeRequest("PATCH",`/v1/chunks/${e}`,i),!0}catch(n){throw n instanceof y&&n.statusCode===404?new A(e,"Chunk"):n}}async updateMemory(e){let t={};if(e.name!==void 0&&(t.name=e.name),e.metadata!==void 0&&(t.metadata=e.metadata,t.merge_metadata=e.mergeMetadata??!1),e.collectionIds!==void 0&&(t.collection_ids=e.collectionIds),Object.keys(t).length===0)throw new k("At least one field (name, metadata, or collectionIds) must be provided to update");try{return await this._makeRequest("PATCH",`/v1/memories/${e.memoryId}`,t),!0}catch(o){throw o instanceof y&&o.statusCode===404?new A(e.memoryId,"Memory"):o}}async listMemories(e){let t=Array.isArray(e.collection_ids)?e.collection_ids:[e.collection_ids];if(!t.length)throw new f("collection_ids must be provided to list_memories().");let o={limit:e.limit??100,offset:e.offset??0,collection_ids:t};e.metadata_filters&&(o.metadata_filters=JSON.stringify(e.metadata_filters));let i=await this._makeRequest("GET","/v1/memories",void 0,o),n;return typeof i=="object"&&i!==null&&"results"in i?n=i.results:Array.isArray(i)?n=i:n=[i],n.map(l=>this._memoryResponseFromDict(l,t))}async getMemory(e){let t=await this._makeRequest("GET",`/v1/memories/${e}`),o=t.text||t.content,i=Array.isArray(t.chunks)?t.chunks:void 0,n={id:t.id,content:o,chunks:i,metadata:t.metadata||{},collection_ids:t.collection_ids||[]};return this._memoryResponseFromDict(n,[])}async search(e){let t={query:e.query};if(e.effort&&(t.effort=e.effort),e.collection_ids){let u=(Array.isArray(e.collection_ids)?e.collection_ids:[e.collection_ids]).filter(d=>d&&d.trim()!=="");u.length&&(t.collection_ids=u)}e.filters&&(t.filters=e.filters),e.searchSettings&&(t.search_settings=e.searchSettings);let i=(await this._makeRequest("POST","/v1/memories/search",t)).results;return{query:i.query||e.query,entities:i.entities||[],facts:i.facts||[],utterances:i.utterances||[],inference_hints:i.inference_hints||[],fact_to_chunks:i.fact_to_chunks||{},entity_to_facts:i.entity_to_facts||{},retrieved_at:i.retrieved_at||new Date().toISOString(),focus:i.focus,total_traversal_time_ms:i.total_traversal_time_ms,query_intent:i.query_intent}}async healthCheck(){return this._makeRequest("GET","/v1/health")}_collectionFromDict(e){let t;e.created_at&&(typeof e.created_at=="string"?t=e.created_at:e.created_at instanceof Date&&(t=e.created_at.toISOString()));let o;e.updated_at&&(typeof e.updated_at=="string"?o=e.updated_at:e.updated_at instanceof Date&&(o=e.updated_at.toISOString()));let i=String(e.id||""),n=String(e.name||""),l=typeof e.description=="string"?e.description:void 0,u=e.owner_id?String(e.owner_id):void 0,d=typeof e.memory_count=="number"?e.memory_count:0,a={graph_collection_status:String(e.graph_collection_status||""),graph_sync_status:String(e.graph_sync_status||""),user_count:typeof e.user_count=="number"?e.user_count:0};return{id:i,name:n,description:l,metadata:a,created_at:t,updated_at:o,memory_count:d,owner_id:u}}_memoryResponseFromDict(e,t){let o;e.created_at&&(typeof e.created_at=="string"?o=e.created_at:e.created_at instanceof Date&&(o=e.created_at.toISOString()));let i;e.updated_at&&(typeof e.updated_at=="string"?i=e.updated_at:e.updated_at instanceof Date&&(i=e.updated_at.toISOString()));let n=String(e.id||""),l=typeof e.content=="string"?e.content:typeof e.text=="string"?e.text:void 0,u;e.chunks&&Array.isArray(e.chunks)&&(e.chunks.every(r=>typeof r=="string")?u=e.chunks.map(r=>({id:"",content:r,metadata:{}})):u=e.chunks.filter(r=>r&&typeof r=="object"&&("text"in r||"content"in r)).map(r=>({id:String(r.id||""),content:String(r.text||r.content||""),metadata:typeof r.metadata=="object"&&r.metadata!==null?r.metadata:{},role:typeof r.role=="string"?r.role:void 0})));let d={...typeof e.metadata=="object"&&e.metadata!==null?e.metadata:{}};e.engram_id&&(d.engram_id=e.engram_id);let a=n;return e.engram_id&&!n&&(a=String(e.engram_id)),e.document_metadata&&typeof e.document_metadata=="object"&&Object.assign(d,e.document_metadata),{id:a,memory_id:a,content:l,chunks:u,metadata:d,collection_ids:Array.isArray(e.collection_ids)?e.collection_ids:t,created_at:o,updated_at:i}}_searchResultFromDict(e){let t=typeof e.content=="string"?e.content:typeof e.text=="string"?e.text:"",o=String(e.id||e.chunk_id||"");return{id:String(o),content:String(t),score:typeof e.score=="number"?e.score:Number(e.score||0),metadata:typeof e.metadata=="object"&&e.metadata!==null?e.metadata:{},source:typeof e.source=="string"?e.source:void 0}}_searchResultFromGraphDict(e){let t=e.id?String(e.id):"",o=typeof e.result_type=="string"?e.result_type:"entity",i=O[o.toUpperCase()]||"entity",n=typeof e.content=="object"&&e.content!==null?e.content:{},l=e.score!==void 0?Number(e.score):0,u=typeof e.metadata=="object"&&e.metadata!==null?e.metadata:{},d=Array.isArray(e.chunk_ids)?e.chunk_ids:void 0,a;if(e.timestamp)if(typeof e.timestamp=="string")a=e.timestamp;else if(e.timestamp instanceof Date)a=e.timestamp.toISOString();else{let M=new Date(String(e.timestamp));Number.isNaN(M.valueOf())||(a=M.toISOString())}let r=typeof e.display_name=="string"?e.display_name:void 0,c=typeof e.source_role=="string"?e.source_role:void 0,m=e.engram_id?String(e.engram_id):void 0,h=e.owner_id?String(e.owner_id):void 0,_,w,v;return i==="entity"?_={id:n.id?String(n.id):void 0,name:String(n.name||""),description:String(n.description||""),metadata:typeof n.metadata=="object"&&n.metadata!==null?n.metadata:{}}:i==="relationship"?w={id:n.id?String(n.id):void 0,subject:String(n.subject||""),predicate:String(n.predicate||""),object:String(n.object||""),subject_id:n.subject_id?String(n.subject_id):void 0,object_id:n.object_id?String(n.object_id):void 0,description:typeof n.description=="string"?n.description:void 0,metadata:typeof n.metadata=="object"&&n.metadata!==null?n.metadata:{}}:v={id:n.id?String(n.id):void 0,name:String(n.name||""),summary:String(n.summary||""),metadata:typeof n.metadata=="object"&&n.metadata!==null?n.metadata:{}},{id:t,score:l,metadata:u,source:"graph",content:void 0,graph_result_type:i,graph_entity:_,graph_relationship:w,graph_community:v,chunk_ids:d,timestamp:a,display_name:r,source_role:c,engram_id:m,owner_id:h}}async _sha256(e){let t=new TextEncoder().encode(e),o;typeof globalThis.crypto<"u"&&globalThis.crypto.subtle?o=globalThis.crypto:o=(await import("crypto")).webcrypto;let i=await o.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(i)).map(u=>u.toString(16).padStart(2,"0")).join("")}_formDataFromObject(e){let t=new FormData;return Object.entries(e).forEach(([o,i])=>{t.append(o,i)}),t}async _processContentParts(e){let t=[];for(let o of e){if(o.type!=="text"&&o.type!=="s3_ref"&&"data"in o&&o.data){let i=o,n=Math.floor(String(i.data).length*3/4);if(n>B.MAX_INLINE_SIZE){let l=i.filename||"file.bin",u=i.media_type||"application/octet-stream",d=await this.getUploadUrl({filename:l,content_type:u,file_size:n}),a,r=globalThis.atob;if(typeof r=="function"){let c=r(String(i.data));a=new Uint8Array(c.length);for(let m=0;m<c.length;m++)a[m]=c.charCodeAt(m)}else{let{Buffer:c}=await import("buffer");a=Uint8Array.from(c.from(String(i.data),"base64"))}await fetch(d.upload_url,{method:"PUT",body:a,headers:{"Content-Type":u}}),t.push({type:"s3_ref",s3_key:d.s3_key,media_type:u,filename:l});continue}}t.push(o)}return t}async getUploadUrl(e){let t=await this._makeRequest("POST","/v1/memories/upload",void 0,{filename:e.filename,content_type:e.content_type,file_size:e.file_size});return t.results?t.results:t}};z.MAX_INLINE_SIZE=5*1024*1024;var G=z,ye={".jpg":"image/jpeg",".jpeg":"image/jpeg",".png":"image/png",".gif":"image/gif",".webp":"image/webp",".heic":"image/heic",".bmp":"image/bmp",".tiff":"image/tiff",".mp3":"audio/mpeg",".wav":"audio/wav",".m4a":"audio/m4a",".ogg":"audio/ogg",".flac":"audio/flac",".aac":"audio/aac",".webm":"audio/webm",".pdf":"application/pdf",".doc":"application/msword",".docx":"application/vnd.openxmlformats-officedocument.wordprocessingml.document",".xls":"application/vnd.ms-excel",".xlsx":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",".ppt":"application/vnd.ms-powerpoint",".pptx":"application/vnd.openxmlformats-officedocument.presentationml.presentation",".txt":"text/plain",".csv":"text/csv",".rtf":"application/rtf",".epub":"application/epub+zip"},j=class{static async fromFile(s,e){let t,o;try{t=await import("fs/promises"),o=await import("path")}catch{throw new Error("File system operations are only supported in Node.js environments.")}let i=o.resolve(s),n=o.basename(i),l=o.extname(i).toLowerCase(),u=e||ye[l]||"application/octet-stream";return{data:(await t.readFile(i)).toString("base64"),media_type:u,filename:n}}},he=s=>s,_e=Object.assign(he,{File:j.fromFile,async fromFile(s,e,t,o){return{collection_id:e,content:[await j.fromFile(s)],metadata:t||{},role:o}}});p.GraphSearchResultType=O;p.Memory=_e;p.Nebula=G;p.NebulaAuthenticationException=K;p.NebulaClientException=f;p.NebulaCollectionNotFoundException=pe;p.NebulaContent=j;p.NebulaException=y;p.NebulaNotFoundException=A;p.NebulaRateLimitException=U;p.NebulaValidationException=k;p.default=G});var H=S((nt,Y)=>{var{Nebula:ge}=J(),we="claudecode_default",q=class{constructor(e,t){if(!e)throw new Error("NEBULA_API_KEY is required");this.client=new ge({apiKey:e}),this.collectionId=t||we}async addMemory(e,t,o={},i=null){let n={collection_id:t||this.collectionId,content:e,metadata:{source:"claude-nebula-plugin",timestamp:new Date().toISOString(),...o}};return i&&(n.id=i),{id:await this.client.storeMemory(n),status:"success",collectionId:t||this.collectionId}}async search(e,t,o={}){let i={query:e,collection_ids:[t||this.collectionId],limit:o.limit||10},n=await this.client.search(i),l=n.utterances||[];return{results:l.map(u=>({id:u.chunk_id||u.engram_id,memory:u.text||"",similarity:u.activation_score||0,title:u.display_name,content:u.text||"",timestamp:u.timestamp})),total:l.length,timing:n.total_traversal_time_ms,entities:n.entities||[],facts:n.facts||[]}}async getProfile(e,t){let o=e||this.collectionId;try{let i=await this.search(t||"user profile preferences recent work",o,{limit:15}),n=i.results,l=i.entities.filter(d=>d.entity_category==="idea"||d.entity_name.toLowerCase().includes("user")).slice(0,5).map(d=>d.profile?.entity?.description||d.entity_name).filter(Boolean),u=i.facts.slice(0,5).map(d=>`${d.subject} ${d.predicate} ${d.object_value}`).filter(Boolean);return{profile:{static:l,dynamic:u},searchResults:n.length>0?i:void 0}}catch(i){return console.warn("Profile search failed:",i.message),{profile:{static:[],dynamic:[]},searchResults:void 0}}}async listMemories(e,t=20){return{memories:(await this.search("recent work memories",e,{limit:t})).results.map(i=>({id:i.id,content:i.memory,similarity:i.similarity,createdAt:i.timestamp}))}}async deleteMemory(e){try{return await this.client.deleteMemory(e),{success:!0,id:e}}catch(t){return console.warn("Nebula DELETE operation failed:",t.message),{success:!1,error:t.message,id:e}}}async createCollection(e,t={}){let o={name:e,metadata:{source:"claude-code-plugin",created_at:new Date().toISOString(),...t}},i=await this.client.createCollection(o);return{id:i.id||i.collection_id||e,name:i.name||e}}};Y.exports={NebulaClient:q}});var Z=S((st,W)=>{var E=require("node:fs"),V=require("node:path"),Se=require("node:os"),R=V.join(Se.homedir(),".nebula-claude"),I=V.join(R,"collections.json"),F=class{constructor(e){this.client=e,this.cache=this._loadCache()}_ensureDir(){E.existsSync(R)||E.mkdirSync(R,{recursive:!0})}_loadCache(){try{if(E.existsSync(I)){let e=E.readFileSync(I,"utf-8");return JSON.parse(e)}}catch(e){console.error(`Failed to load collections cache: ${e.message}`)}return{}}_saveCache(){this._ensureDir();try{E.writeFileSync(I,JSON.stringify(this.cache,null,2))}catch(e){console.error(`Failed to save collections cache: ${e.message}`)}}_generateFriendlyName(e,t){return t&&t!==e?t.replace(/[^a-zA-Z0-9-_]/g,"_").toLowerCase():`project_${e.substring(0,8)}`}async getOrCreateCollection(e,t=null){if(this.cache[e])return this.cache[e];let o=this._generateFriendlyName(e,t);try{let i=await this.client.createCollection(o,{container_tag:e,project_name:t}),n={id:i.id,name:i.name||o,containerTag:e,createdAt:new Date().toISOString()};return this.cache[e]=n,this._saveCache(),n}catch(i){if(i.message.includes("409")||i.message.includes("exists")){console.warn(`Collection ${o} already exists, using name as ID`);let n={id:o,name:o,containerTag:e,createdAt:new Date().toISOString()};return this.cache[e]=n,this._saveCache(),n}throw new Error(`Failed to create collection: ${i.message}`)}}getCollectionId(e){return this.cache[e]?.id||null}clearCache(){this.cache={},this._saveCache()}};W.exports={CollectionManager:F,SETTINGS_DIR:R,COLLECTIONS_FILE:I}});var ee=S((rt,Q)=>{var{execSync:X}=require("node:child_process"),be=require("node:crypto");function P(s){return be.createHash("sha256").update(s).digest("hex").slice(0,16)}function $(s){try{return X("git rev-parse --show-toplevel",{cwd:s,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim()||null}catch{return null}}function ve(s){let t=$(s)||s;return`claudecode_project_${P(t)}`}function Ae(s){return($(s)||s).split("/").pop()||"unknown"}function Ee(){try{let e=X("git config user.email",{encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim();if(e)return`claudecode_user_${P(e)}`}catch{}let s=process.env.USER||process.env.USERNAME||"anonymous";return`claudecode_user_${P(s)}`}function Ce(s,e){return e&&e!=="unknown"?e.replace(/[^a-zA-Z0-9-_]/g,"_").toLowerCase():`project_${s.replace("claudecode_project_","")}`}Q.exports={sha256:P,getGitRoot:$,getContainerTag:ve,getProjectName:Ae,getUserContainerTag:Ee,getCollectionName:Ce}});var ie=S((at,oe)=>{var g=require("node:fs"),te=require("node:path"),Ne=require("node:os"),T=te.join(Ne.homedir(),".nebula-claude"),b=te.join(T,"credentials.json"),xe=process.env.NEBULA_API_URL||"https://api.trynebula.ai";function ke(){g.existsSync(T)||g.mkdirSync(T,{recursive:!0})}function Ie(){try{if(g.existsSync(b)){let s=JSON.parse(g.readFileSync(b,"utf-8"));if(s.apiKey)return s}}catch{}return null}function Re(s){ke();let e={apiKey:s,savedAt:new Date().toISOString(),apiUrl:xe};g.writeFileSync(b,JSON.stringify(e,null,2))}function Pe(){try{g.existsSync(b)&&g.unlinkSync(b)}catch{}}async function Te(s){return!s||typeof s!="string"||s.trim().length===0?{valid:!1,error:"API key must be a non-empty string"}:{valid:!0}}oe.exports={SETTINGS_DIR:T,CREDENTIALS_FILE:b,loadCredentials:Ie,saveCredentials:Re,clearCredentials:Pe,validateApiKey:Te}});var ae=S((ct,re)=>{var N=require("node:fs"),ne=require("node:path"),De=require("node:os"),{loadCredentials:je}=ie(),D=ne.join(De.homedir(),".nebula-claude"),C=ne.join(D,"settings.json"),se={skipTools:["Read","Glob","Grep","TodoWrite","AskUserQuestion"],captureTools:["Edit","Write","Bash","Task"],maxProfileItems:5,debug:!1,injectProfile:!0};function Oe(){N.existsSync(D)||N.mkdirSync(D,{recursive:!0})}function qe(){let s={...se};try{if(N.existsSync(C)){let e=N.readFileSync(C,"utf-8");Object.assign(s,JSON.parse(e))}}catch(e){console.error(`Settings: Failed to load ${C}: ${e.message}`)}return process.env.NEBULA_API_KEY&&(s.apiKey=process.env.NEBULA_API_KEY),process.env.NEBULA_SKIP_TOOLS&&(s.skipTools=process.env.NEBULA_SKIP_TOOLS.split(",").map(e=>e.trim())),process.env.NEBULA_DEBUG==="true"&&(s.debug=!0),s}function Fe(s){Oe();let e={...s};delete e.apiKey,N.writeFileSync(C,JSON.stringify(e,null,2))}function $e(s){if(s.apiKey)return s.apiKey;if(process.env.NEBULA_API_KEY)return process.env.NEBULA_API_KEY;let e=je();if(e?.apiKey)return e.apiKey;throw new Error("NO_API_KEY")}function Me(s,e){return e.skipTools.includes(s)?!1:e.captureTools&&e.captureTools.length>0?e.captureTools.includes(s):!0}function Le(s,e,t){if(s.debug){let o=new Date().toISOString();console.error(t?`[${o}] ${e}: ${JSON.stringify(t)}`:`[${o}] ${e}`)}}re.exports={SETTINGS_DIR:D,SETTINGS_FILE:C,DEFAULT_SETTINGS:se,loadSettings:qe,saveSettings:Fe,getApiKey:$e,shouldCaptureTool:Me,debugLog:Le}});var{NebulaClient:Ke}=H(),{CollectionManager:Ue}=Z(),{getContainerTag:ze,getProjectName:Be}=ee(),{loadSettings:Ge,getApiKey:Je}=ae();async function Ye(){let s=process.argv.slice(2).join(" ");if(!s||!s.trim()){console.log("No search query provided. Please specify what you want to search for.");return}let e=Ge(),t;try{t=Je(e)}catch{console.log("Nebula API key not configured."),console.log("Set NEBULA_API_KEY environment variable to enable memory search."),console.log("Get your key at: https://trynebula.ai/settings/api-keys");return}let o=process.cwd(),i=ze(o),n=Be(o);try{let l=new Ke(t),a=(await new Ue(l).getOrCreateCollection(i,n).catch(()=>null))?.id||i,r=await l.getProfile(a,s);if(console.log(`## Memory Search: "${s}"`),console.log(`Project: ${n}
`),r.profile&&(r.profile.static?.length>0&&(console.log("### User Preferences"),r.profile.static.forEach(c=>console.log(`- ${c}`)),console.log("")),r.profile.dynamic?.length>0&&(console.log("### Recent Context"),r.profile.dynamic.forEach(c=>console.log(`- ${c}`)),console.log(""))),r.searchResults?.results?.length>0)console.log("### Relevant Memories"),r.searchResults.results.forEach((c,m)=>{let h=Math.round(c.similarity*100),_=c.memory||c.content||"";console.log(`
**Memory ${m+1}** (${h}% match)`),c.title&&console.log(`*${c.title}*`),console.log(_.slice(0,500))});else{let c=await l.search(s,a,{limit:10});c.results?.length>0?(console.log("### Relevant Memories"),c.results.forEach((m,h)=>{let _=Math.round(m.similarity*100),w=m.memory||m.content||"";console.log(`
**Memory ${h+1}** (${_}% match)`),m.title&&console.log(`*${m.title}*`),console.log(w.slice(0,500))})):(console.log("No memories found matching your query."),console.log("Memories are automatically saved as you work in this project."))}}catch(l){console.log(`Error searching memories: ${l.message}`)}}Ye().catch(s=>{console.error(`Fatal error: ${s.message}`),process.exit(1)});
