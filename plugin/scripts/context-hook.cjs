#!/usr/bin/env node
var le=Object.create;var K=Object.defineProperty;var ue=Object.getOwnPropertyDescriptor;var de=Object.getOwnPropertyNames;var me=Object.getPrototypeOf,fe=Object.prototype.hasOwnProperty;var S=(o,e)=>()=>(e||o((e={exports:{}}).exports,e),e.exports);var pe=(o,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of de(e))!fe.call(o,i)&&i!==t&&K(o,i,{get:()=>e[i],enumerable:!(n=ue(e,i))||n.enumerable});return o};var k=(o,e,t)=>(t=o!=null?le(me(o)):{},pe(e||!o||!o.__esModule?K(t,"default",{value:o,enumerable:!0}):t,o));var G=S(f=>{"use strict";Object.defineProperty(f,"__esModule",{value:!0});var q=(o=>(o.ENTITY="entity",o.RELATIONSHIP="relationship",o.COMMUNITY="community",o))(q||{}),y=class extends Error{constructor(o,e,t){super(o),this.statusCode=e,this.details=t,this.name="NebulaException"}},m=class extends y{constructor(o,e){super(o),this.cause=e,this.name="NebulaClientException"}},L=class extends y{constructor(o="Invalid API key"){super(o,401),this.name="NebulaAuthenticationException"}},U=class extends y{constructor(o="Rate limit exceeded"){super(o,429),this.name="NebulaRateLimitException"}},C=class extends y{constructor(o="Validation error",e){super(o,400),this.details=e,this.name="NebulaValidationException"}},ye=class extends y{constructor(o="Collection not found"){super(o,404),this.name="NebulaCollectionNotFoundException"}},v=class extends y{constructor(o,e="Resource"){super(`${e} not found: ${o}`,404),this.name="NebulaNotFoundException"}},M=class z{constructor(e={}){if(this.apiKey=e.apiKey,!this.apiKey)throw new m("API key is required. Pass it to the constructor or set NEBULA_API_KEY environment variable.");this.baseUrl=(e.baseUrl||"https://api.trynebula.ai").replace(/\/$/,""),this.timeout=e.timeout||3e4}setApiKey(e){this.apiKey=e}setBaseUrl(e){this.baseUrl=(e||this.baseUrl).replace(/\/$/,"")}setCorsProxy(e){}isApiKeySet(){return!!(this.apiKey&&this.apiKey.trim()!=="")}_isNebulaApiKey(e){let t=e||this.apiKey;if(!t)return!1;let n=t.split(".");if(n.length!==2)return!1;let[i,r]=n;return(i.startsWith("key_")||i.startsWith("neb_"))&&!!r&&r.length>0}_buildAuthHeaders(e=!0){let t={};return this._isNebulaApiKey()?t["X-API-Key"]=this.apiKey:t.Authorization=`Bearer ${this.apiKey}`,e&&(t["Content-Type"]="application/json"),t}_isRecord(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)}_unwrapResults(e){return this._isRecord(e)&&"results"in e?e.results:e}_unwrapResultsArray(e){let t=this._unwrapResults(e);return Array.isArray(t)?t:t==null?[]:[t]}_looksLikeMultimodalContent(e){return Array.isArray(e)?e.some(t=>this._isRecord(t)?typeof t.type=="string"||"data"in t||"s3_key"in t||"url"in t:!1):!1}_normalizeContentParts(e){return e.map(t=>typeof t=="string"?{type:"text",text:t}:this._isRecord(t)?typeof t.type=="string"?t:"s3_key"in t&&typeof t.s3_key=="string"?{type:"s3_ref",s3_key:t.s3_key,bucket:typeof t.bucket=="string"?t.bucket:void 0,media_type:typeof t.media_type=="string"?t.media_type:"application/octet-stream",filename:typeof t.filename=="string"?t.filename:void 0,size_bytes:typeof t.size_bytes=="number"?t.size_bytes:void 0}:"data"in t&&typeof t.data=="string"?{type:"file",data:t.data,media_type:typeof t.media_type=="string"?t.media_type:"application/octet-stream",filename:typeof t.filename=="string"?t.filename:void 0,duration_seconds:typeof t.duration_seconds=="number"?t.duration_seconds:void 0}:{type:"text",text:String(t)}:{type:"text",text:String(t)})}async _serializeContentAsText(e){if(this._looksLikeMultimodalContent(e)){let t=this._normalizeContentParts(e),n=await this._processContentParts(t);return JSON.stringify(n)}return typeof e=="object"&&e!==null?JSON.stringify(e):String(e??"")}async _serializeContentAsParts(e){if(!this._looksLikeMultimodalContent(e))return null;let t=this._normalizeContentParts(e);return await this._processContentParts(t)}async _makeRequest(e,t,n,i){let r=new URL(t,this.baseUrl);i&&Object.entries(i).forEach(([a,s])=>{s!=null&&(Array.isArray(s)?s.forEach(u=>{r.searchParams.append(a,String(u))}):r.searchParams.append(a,String(s)))});let c=this._buildAuthHeaders(!0),l=new AbortController,d=setTimeout(()=>l.abort(),this.timeout);try{let a=await fetch(r.toString(),{method:e,headers:c,body:n?JSON.stringify(n):void 0,signal:l.signal});if(clearTimeout(d),a.status===200||a.status===202)return await a.json();if(a.status===401)throw new L("Invalid API key");if(a.status===429)throw new U("Rate limit exceeded");if(a.status===400){let s=await a.json().catch(()=>({}));throw new C(s.message||"Validation error",s.details)}else if(a.status===422){let s=await a.json().catch(()=>({}));throw console.error("[SDK] 422 Validation error - Full details:"),console.error("  Status:",a.status),console.error("  Error data:",JSON.stringify(s,null,2)),console.error("  Message:",s.message),console.error("  Detail:",s.detail),new C(s.message||(typeof s.detail=="string"?s.detail:JSON.stringify(s.detail))||"Validation error",s)}else{let s=await a.json().catch(()=>({}));throw new y(s.message||`API error: ${a.status}`,a.status,s)}}catch(a){throw clearTimeout(d),a instanceof y?a:a instanceof Error&&a.name==="AbortError"?new m(`Request timed out after ${this.timeout} milliseconds`):a instanceof Error?new m(`Request failed: ${a.message}`,a):new m(`Request failed: ${String(a)}`)}}async createCollection(e){let t={name:e.name};e.description&&(t.description=e.description),e.metadata&&(t.metadata=e.metadata);let n=await this._makeRequest("POST","/v1/collections",t),i=n.results||n;return this._collectionFromDict(i)}async getCollection(e){let t=await this._makeRequest("GET",`/v1/collections/${e}`),n=t.results||t;return this._collectionFromDict(n)}async getCollectionByName(e){let t=await this._makeRequest("GET",`/v1/collections/name/${e}`),n=t.results||t;return this._collectionFromDict(n)}async listCollections(e){let t={limit:e?.limit??100,offset:e?.offset??0};e?.name!==void 0&&(t.name=e.name);let n=await this._makeRequest("GET","/v1/collections",void 0,t),i;return typeof n=="object"&&n!==null&&"results"in n?i=n.results:Array.isArray(n)?i=n:i=[n],i.map(r=>this._collectionFromDict(r))}async updateCollection(e){let t={};e.name!==void 0&&(t.name=e.name),e.description!==void 0&&(t.description=e.description),e.metadata!==void 0&&(t.metadata=e.metadata);let n=await this._makeRequest("POST",`/v1/collections/${e.collectionId}`,t),i=n.results||n;return this._collectionFromDict(i)}async deleteCollection(e){return await this._makeRequest("DELETE",`/v1/collections/${e}`),!0}async store(e,t,n={}){let i={...n,memory_type:"memory",timestamp:new Date().toISOString()},r={collection_id:t,raw_text:String(e||""),metadata:i,ingestion_mode:"fast"},c=await this._makeRequest("POST","/v1/memories",r),l=c?.results?.engram_id||c?.results?.id||c?.id||"",d=i.timestamp;return{id:String(l),memory_id:String(l),content:String(e||""),metadata:i,collection_ids:[t],created_at:d,updated_at:d}}async storeMemory(e,t){let n;if("collection_id"in e)n=e;else{let u=e;n={collection_id:u.collection_id||u.collectionId||"",content:u.content||"",role:u.role,memory_id:u.memory_id||u.memoryId||void 0,metadata:u.metadata||{}}}if(n.memory_id)return await this._appendToMemory(n.memory_id,n);if((n.role?"conversation":"document")==="conversation"){let u=[];if(n.content&&n.role){let E=await this._serializeContentAsParts(n.content)??await this._serializeContentAsText(n.content),b=n;u.push({content:E,role:n.role,metadata:n.metadata||{},...typeof b.authority=="number"?{authority:Number(b.authority)}:{}})}if(u.length===0)throw new m("Cannot create conversation without messages. Provide content and role.");let p={collection_id:n.collection_id,name:t||"Conversation",messages:u,metadata:n.metadata||{}},_=await this._makeRequest("POST","/v1/memories",p);if(_.results){let g=_.results.memory_id||_.results.id;if(!g)throw new m("Failed to create conversation: no id returned");return String(g)}throw new m("Failed to create conversation: invalid response format")}let r={...n.metadata};r.memory_type="memory";let c=n;if(typeof c.authority=="number"){let u=Number(c.authority);!Number.isNaN(u)&&u>=0&&u<=1&&(r.authority=u)}let l,d=await this._serializeContentAsParts(n.content);if(d)l={collection_id:n.collection_id,content_parts:d,metadata:r,ingestion_mode:"fast"};else if(Array.isArray(n.content)&&n.content.every(u=>typeof u=="string"))l={collection_id:n.collection_id,chunks:n.content,metadata:r,ingestion_mode:"fast"};else{let u=await this._serializeContentAsText(n.content);if(!u||u==='""'||u==="[]"||u==="{}")throw new m("Content is required for document memories");l={collection_id:n.collection_id,raw_text:u,metadata:r,ingestion_mode:"fast"}}let a=await this._makeRequest("POST","/v1/memories",l),s=a?.results?.engram_id||a?.results?.id||a?.id||"";return String(s||"")}async _appendToMemory(e,t){let n=t.collection_id,i=t.content,r=t.metadata;if(!n)throw new m("collection_id is required");let c={collection_id:n};if(Array.isArray(i))i.length>0&&typeof i[0]=="object"&&"content"in i[0]?c.messages=i:c.chunks=i;else if(typeof i=="string")c.raw_text=i;else throw new m("content must be a string, array of strings, or array of message objects");r&&(c.metadata=r);try{return await this._makeRequest("POST",`/v1/memories/${e}/append`,c),e}catch(l){throw l instanceof y&&l.statusCode===404?new v(e,"Memory"):l}}async storeMemories(e){let t=[],n={},i=[];for(let r of e)if(r.role){let c=r.memory_id||`__new__::${r.collection_id}`;n[c]||(n[c]=[]),n[c].push(r)}else i.push(r);for(let[r,c]of Object.entries(n)){let l=c[0].collection_id,d,a=[];for(let s of c){let p=await this._serializeContentAsParts(s.content)??await this._serializeContentAsText(s.content);if(typeof p=="string"){if(!p.trim())continue}else if(p.length===0)continue;let _=s;a.push({content:p,role:s.role,metadata:s.metadata||{},...typeof _.authority=="number"?{authority:Number(_.authority)}:{}})}if(!a.length)throw new m("Cannot create/append conversation without messages. Provide non-empty content.");if(r.startsWith("__new__::")){let s={collection_id:l,name:"Conversation",messages:a,metadata:{}},u=await this._makeRequest("POST","/v1/memories",s);if(u.results){if(d=u.results.memory_id||u.results.id||"",!d)throw new m("Failed to create conversation: no id returned")}else throw new m("Failed to create conversation: invalid response format")}else{d=r;let s={collection_id:l,content:a,memory_id:d,metadata:{}};await this._appendToMemory(d,s)}t.push(...Array(c.length).fill(String(d)))}for(let r of i)t.push(await this.storeMemory(r));return t}async delete(e){try{if(console.log("[SDK] delete() called with:",{memoryIds:e,type:typeof e,isArray:Array.isArray(e)}),typeof e=="string"){console.log("[SDK] Single deletion path for ID:",e);try{return await this._makeRequest("DELETE",`/v1/memories/${e}`),!0}catch{console.log("[SDK] Falling back to POST /v1/memories/delete with single ID");let t=await this._makeRequest("POST","/v1/memories/delete",e);return typeof t=="object"&&t.success!==void 0?t.success:!0}}else{console.log("[SDK] Batch deletion path for IDs:",e),console.log("[SDK] Sending POST request with body:",e);let t=await this._makeRequest("POST","/v1/memories/delete",e);return console.log("[SDK] Batch deletion response:",t),t}}catch(t){throw console.error("[SDK] Delete error:",t),t instanceof Error?t:new m(`Unknown error: ${String(t)}`)}}async deleteChunk(e){try{return await this._makeRequest("DELETE",`/v1/chunks/${e}`),!0}catch(t){throw t instanceof y&&t.statusCode===404?new v(e,"Chunk"):t}}async updateChunk(e,t,n){let i={content:t};n!==void 0&&(i.metadata=n);try{return await this._makeRequest("PATCH",`/v1/chunks/${e}`,i),!0}catch(r){throw r instanceof y&&r.statusCode===404?new v(e,"Chunk"):r}}async updateMemory(e){let t={};if(e.name!==void 0&&(t.name=e.name),e.metadata!==void 0&&(t.metadata=e.metadata,t.merge_metadata=e.mergeMetadata??!1),e.collectionIds!==void 0&&(t.collection_ids=e.collectionIds),Object.keys(t).length===0)throw new C("At least one field (name, metadata, or collectionIds) must be provided to update");try{return await this._makeRequest("PATCH",`/v1/memories/${e.memoryId}`,t),!0}catch(n){throw n instanceof y&&n.statusCode===404?new v(e.memoryId,"Memory"):n}}async listMemories(e){let t=Array.isArray(e.collection_ids)?e.collection_ids:[e.collection_ids];if(!t.length)throw new m("collection_ids must be provided to list_memories().");let n={limit:e.limit??100,offset:e.offset??0,collection_ids:t};e.metadata_filters&&(n.metadata_filters=JSON.stringify(e.metadata_filters));let i=await this._makeRequest("GET","/v1/memories",void 0,n),r;return typeof i=="object"&&i!==null&&"results"in i?r=i.results:Array.isArray(i)?r=i:r=[i],r.map(c=>this._memoryResponseFromDict(c,t))}async getMemory(e){let t=await this._makeRequest("GET",`/v1/memories/${e}`),n=t.text||t.content,i=Array.isArray(t.chunks)?t.chunks:void 0,r={id:t.id,content:n,chunks:i,metadata:t.metadata||{},collection_ids:t.collection_ids||[]};return this._memoryResponseFromDict(r,[])}async search(e){let t={query:e.query};if(e.effort&&(t.effort=e.effort),e.collection_ids){let l=(Array.isArray(e.collection_ids)?e.collection_ids:[e.collection_ids]).filter(d=>d&&d.trim()!=="");l.length&&(t.collection_ids=l)}e.filters&&(t.filters=e.filters),e.searchSettings&&(t.search_settings=e.searchSettings);let i=(await this._makeRequest("POST","/v1/memories/search",t)).results;return{query:i.query||e.query,entities:i.entities||[],facts:i.facts||[],utterances:i.utterances||[],inference_hints:i.inference_hints||[],fact_to_chunks:i.fact_to_chunks||{},entity_to_facts:i.entity_to_facts||{},retrieved_at:i.retrieved_at||new Date().toISOString(),focus:i.focus,total_traversal_time_ms:i.total_traversal_time_ms,query_intent:i.query_intent}}async healthCheck(){return this._makeRequest("GET","/v1/health")}_collectionFromDict(e){let t;e.created_at&&(typeof e.created_at=="string"?t=e.created_at:e.created_at instanceof Date&&(t=e.created_at.toISOString()));let n;e.updated_at&&(typeof e.updated_at=="string"?n=e.updated_at:e.updated_at instanceof Date&&(n=e.updated_at.toISOString()));let i=String(e.id||""),r=String(e.name||""),c=typeof e.description=="string"?e.description:void 0,l=e.owner_id?String(e.owner_id):void 0,d=typeof e.memory_count=="number"?e.memory_count:0,a={graph_collection_status:String(e.graph_collection_status||""),graph_sync_status:String(e.graph_sync_status||""),user_count:typeof e.user_count=="number"?e.user_count:0};return{id:i,name:r,description:c,metadata:a,created_at:t,updated_at:n,memory_count:d,owner_id:l}}_memoryResponseFromDict(e,t){let n;e.created_at&&(typeof e.created_at=="string"?n=e.created_at:e.created_at instanceof Date&&(n=e.created_at.toISOString()));let i;e.updated_at&&(typeof e.updated_at=="string"?i=e.updated_at:e.updated_at instanceof Date&&(i=e.updated_at.toISOString()));let r=String(e.id||""),c=typeof e.content=="string"?e.content:typeof e.text=="string"?e.text:void 0,l;e.chunks&&Array.isArray(e.chunks)&&(e.chunks.every(s=>typeof s=="string")?l=e.chunks.map(s=>({id:"",content:s,metadata:{}})):l=e.chunks.filter(s=>s&&typeof s=="object"&&("text"in s||"content"in s)).map(s=>({id:String(s.id||""),content:String(s.text||s.content||""),metadata:typeof s.metadata=="object"&&s.metadata!==null?s.metadata:{},role:typeof s.role=="string"?s.role:void 0})));let d={...typeof e.metadata=="object"&&e.metadata!==null?e.metadata:{}};e.engram_id&&(d.engram_id=e.engram_id);let a=r;return e.engram_id&&!r&&(a=String(e.engram_id)),e.document_metadata&&typeof e.document_metadata=="object"&&Object.assign(d,e.document_metadata),{id:a,memory_id:a,content:c,chunks:l,metadata:d,collection_ids:Array.isArray(e.collection_ids)?e.collection_ids:t,created_at:n,updated_at:i}}_searchResultFromDict(e){let t=typeof e.content=="string"?e.content:typeof e.text=="string"?e.text:"",n=String(e.id||e.chunk_id||"");return{id:String(n),content:String(t),score:typeof e.score=="number"?e.score:Number(e.score||0),metadata:typeof e.metadata=="object"&&e.metadata!==null?e.metadata:{},source:typeof e.source=="string"?e.source:void 0}}_searchResultFromGraphDict(e){let t=e.id?String(e.id):"",n=typeof e.result_type=="string"?e.result_type:"entity",i=q[n.toUpperCase()]||"entity",r=typeof e.content=="object"&&e.content!==null?e.content:{},c=e.score!==void 0?Number(e.score):0,l=typeof e.metadata=="object"&&e.metadata!==null?e.metadata:{},d=Array.isArray(e.chunk_ids)?e.chunk_ids:void 0,a;if(e.timestamp)if(typeof e.timestamp=="string")a=e.timestamp;else if(e.timestamp instanceof Date)a=e.timestamp.toISOString();else{let $=new Date(String(e.timestamp));Number.isNaN($.valueOf())||(a=$.toISOString())}let s=typeof e.display_name=="string"?e.display_name:void 0,u=typeof e.source_role=="string"?e.source_role:void 0,p=e.engram_id?String(e.engram_id):void 0,_=e.owner_id?String(e.owner_id):void 0,g,E,b;return i==="entity"?g={id:r.id?String(r.id):void 0,name:String(r.name||""),description:String(r.description||""),metadata:typeof r.metadata=="object"&&r.metadata!==null?r.metadata:{}}:i==="relationship"?E={id:r.id?String(r.id):void 0,subject:String(r.subject||""),predicate:String(r.predicate||""),object:String(r.object||""),subject_id:r.subject_id?String(r.subject_id):void 0,object_id:r.object_id?String(r.object_id):void 0,description:typeof r.description=="string"?r.description:void 0,metadata:typeof r.metadata=="object"&&r.metadata!==null?r.metadata:{}}:b={id:r.id?String(r.id):void 0,name:String(r.name||""),summary:String(r.summary||""),metadata:typeof r.metadata=="object"&&r.metadata!==null?r.metadata:{}},{id:t,score:c,metadata:l,source:"graph",content:void 0,graph_result_type:i,graph_entity:g,graph_relationship:E,graph_community:b,chunk_ids:d,timestamp:a,display_name:s,source_role:u,engram_id:p,owner_id:_}}async _sha256(e){let t=new TextEncoder().encode(e),n;typeof globalThis.crypto<"u"&&globalThis.crypto.subtle?n=globalThis.crypto:n=(await import("crypto")).webcrypto;let i=await n.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(i)).map(l=>l.toString(16).padStart(2,"0")).join("")}_formDataFromObject(e){let t=new FormData;return Object.entries(e).forEach(([n,i])=>{t.append(n,i)}),t}async _processContentParts(e){let t=[];for(let n of e){if(n.type!=="text"&&n.type!=="s3_ref"&&"data"in n&&n.data){let i=n,r=Math.floor(String(i.data).length*3/4);if(r>z.MAX_INLINE_SIZE){let c=i.filename||"file.bin",l=i.media_type||"application/octet-stream",d=await this.getUploadUrl({filename:c,content_type:l,file_size:r}),a,s=globalThis.atob;if(typeof s=="function"){let u=s(String(i.data));a=new Uint8Array(u.length);for(let p=0;p<u.length;p++)a[p]=u.charCodeAt(p)}else{let{Buffer:u}=await import("buffer");a=Uint8Array.from(u.from(String(i.data),"base64"))}await fetch(d.upload_url,{method:"PUT",body:a,headers:{"Content-Type":l}}),t.push({type:"s3_ref",s3_key:d.s3_key,media_type:l,filename:c});continue}}t.push(n)}return t}async getUploadUrl(e){let t=await this._makeRequest("POST","/v1/memories/upload",void 0,{filename:e.filename,content_type:e.content_type,file_size:e.file_size});return t.results?t.results:t}};M.MAX_INLINE_SIZE=5*1024*1024;var B=M,_e={".jpg":"image/jpeg",".jpeg":"image/jpeg",".png":"image/png",".gif":"image/gif",".webp":"image/webp",".heic":"image/heic",".bmp":"image/bmp",".tiff":"image/tiff",".mp3":"audio/mpeg",".wav":"audio/wav",".m4a":"audio/m4a",".ogg":"audio/ogg",".flac":"audio/flac",".aac":"audio/aac",".webm":"audio/webm",".pdf":"application/pdf",".doc":"application/msword",".docx":"application/vnd.openxmlformats-officedocument.wordprocessingml.document",".xls":"application/vnd.ms-excel",".xlsx":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",".ppt":"application/vnd.ms-powerpoint",".pptx":"application/vnd.openxmlformats-officedocument.presentationml.presentation",".txt":"text/plain",".csv":"text/csv",".rtf":"application/rtf",".epub":"application/epub+zip"},j=class{static async fromFile(o,e){let t,n;try{t=await import("fs/promises"),n=await import("path")}catch{throw new Error("File system operations are only supported in Node.js environments.")}let i=n.resolve(o),r=n.basename(i),c=n.extname(i).toLowerCase(),l=e||_e[c]||"application/octet-stream";return{data:(await t.readFile(i)).toString("base64"),media_type:l,filename:r}}},he=o=>o,ge=Object.assign(he,{File:j.fromFile,async fromFile(o,e,t,n){return{collection_id:e,content:[await j.fromFile(o)],metadata:t||{},role:n}}});f.GraphSearchResultType=q;f.Memory=ge;f.Nebula=B;f.NebulaAuthenticationException=L;f.NebulaClientException=m;f.NebulaCollectionNotFoundException=ye;f.NebulaContent=j;f.NebulaException=y;f.NebulaNotFoundException=v;f.NebulaRateLimitException=U;f.NebulaValidationException=C;f.default=B});var V=S((ft,H)=>{var{Nebula:Se}=G(),A=require("node:fs"),Y=require("node:path"),we=require("node:os"),T=Y.join(we.homedir(),".nebula-claude","collections.json");function be(o){if(!o)throw new Error("NEBULA_API_KEY is required");return new Se({apiKey:o})}async function ve(o,e,t){let n=Ae();if(n[e])return n[e];let i=t.replace(/[^a-zA-Z0-9-_]/g,"_").toLowerCase();try{let c=(await o.createCollection({name:i})).id||i;return n[e]=c,J(n),c}catch(r){if(r.message?.includes("409")||r.message?.includes("exists"))return n[e]=i,J(n),i;throw r}}function Ae(){try{if(A.existsSync(T))return JSON.parse(A.readFileSync(T,"utf-8"))}catch{}return{}}function J(o){let e=Y.dirname(T);A.existsSync(e)||A.mkdirSync(e,{recursive:!0}),A.writeFileSync(T,JSON.stringify(o,null,2))}function xe(o,e=5){let t=o.utterances||[];return t.length===0?null:`<nebula-context>
Relevant memories from previous sessions:

${t.slice(0,e).map(i=>{let r=i.text||"",c=Math.round((i.activation_score||0)*100);return`- ${r.slice(0,200)}${r.length>200?"...":""} [${c}%]`}).join(`
`)}

Use these memories naturally when relevant.
</nebula-context>`}H.exports={createClient:be,getOrCreateCollection:ve,formatSearchContext:xe}});var X=S((pt,Z)=>{var{execSync:W}=require("node:child_process"),Ne=require("node:crypto");function P(o){return Ne.createHash("sha256").update(o).digest("hex").slice(0,16)}function D(o){try{return W("git rev-parse --show-toplevel",{cwd:o,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim()||null}catch{return null}}function Ee(o){let t=D(o)||o;return`claudecode_project_${P(t)}`}function ke(o){return(D(o)||o).split("/").pop()||"unknown"}function Ce(){try{let e=W("git config user.email",{encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim();if(e)return`claudecode_user_${P(e)}`}catch{}let o=process.env.USER||process.env.USERNAME||"anonymous";return`claudecode_user_${P(o)}`}function Te(o,e){return e&&e!=="unknown"?e.replace(/[^a-zA-Z0-9-_]/g,"_").toLowerCase():`project_${o.replace("claudecode_project_","")}`}Z.exports={sha256:P,getGitRoot:D,getContainerTag:Ee,getProjectName:ke,getUserContainerTag:Ce,getCollectionName:Te}});var te=S((yt,ee)=>{var h=require("node:fs"),Q=require("node:path"),Pe=require("node:os"),I=Q.join(Pe.homedir(),".nebula-claude"),w=Q.join(I,"credentials.json"),Ie=process.env.NEBULA_API_URL||"https://api.trynebula.ai";function Re(){h.existsSync(I)||h.mkdirSync(I,{recursive:!0})}function Oe(){try{if(h.existsSync(w)){let o=JSON.parse(h.readFileSync(w,"utf-8"));if(o.apiKey)return o}}catch{}return null}function je(o){Re();let e={apiKey:o,savedAt:new Date().toISOString(),apiUrl:Ie};h.writeFileSync(w,JSON.stringify(e,null,2))}function qe(){try{h.existsSync(w)&&h.unlinkSync(w)}catch{}}async function De(o){return!o||typeof o!="string"||o.trim().length===0?{valid:!1,error:"API key must be a non-empty string"}:{valid:!0}}ee.exports={SETTINGS_DIR:I,CREDENTIALS_FILE:w,loadCredentials:Oe,saveCredentials:je,clearCredentials:qe,validateApiKey:De}});var re=S((_t,ie)=>{var N=require("node:fs"),ne=require("node:path"),Fe=require("node:os"),{loadCredentials:$e}=te(),R=ne.join(Fe.homedir(),".nebula-claude"),x=ne.join(R,"settings.json"),oe={skipTools:["Read","Glob","Grep","TodoWrite","AskUserQuestion"],captureTools:["Edit","Write","Bash","Task"],maxProfileItems:5,debug:!1,injectProfile:!0};function Ke(){N.existsSync(R)||N.mkdirSync(R,{recursive:!0})}function Le(){let o={...oe};try{if(N.existsSync(x)){let e=N.readFileSync(x,"utf-8");Object.assign(o,JSON.parse(e))}}catch(e){console.error(`Settings: Failed to load ${x}: ${e.message}`)}return process.env.NEBULA_API_KEY&&(o.apiKey=process.env.NEBULA_API_KEY),process.env.NEBULA_SKIP_TOOLS&&(o.skipTools=process.env.NEBULA_SKIP_TOOLS.split(",").map(e=>e.trim())),process.env.NEBULA_DEBUG==="true"&&(o.debug=!0),o}function Ue(o){Ke();let e={...o};delete e.apiKey,N.writeFileSync(x,JSON.stringify(e,null,2))}function Me(o){if(o.apiKey)return o.apiKey;if(process.env.NEBULA_API_KEY)return process.env.NEBULA_API_KEY;let e=$e();if(e?.apiKey)return e.apiKey;throw new Error("NO_API_KEY")}function ze(o,e){return e.skipTools.includes(o)?!1:e.captureTools&&e.captureTools.length>0?e.captureTools.includes(o):!0}function Be(o,e,t){if(o.debug){let n=new Date().toISOString();console.error(t?`[${n}] ${e}: ${JSON.stringify(t)}`:`[${n}] ${e}`)}}ie.exports={SETTINGS_DIR:R,SETTINGS_FILE:x,DEFAULT_SETTINGS:oe,loadSettings:Le,saveSettings:Ue,getApiKey:Me,shouldCaptureTool:ze,debugLog:Be}});var ae=S((ht,se)=>{async function Ge(){return new Promise((o,e)=>{let t="";process.stdin.setEncoding("utf8"),process.stdin.on("data",n=>{t+=n}),process.stdin.on("end",()=>{try{o(t.trim()?JSON.parse(t):{})}catch(n){e(new Error(`Failed to parse stdin JSON: ${n.message}`))}}),process.stdin.on("error",e),process.stdin.isTTY&&o({})})}function O(o){console.log(JSON.stringify(o))}function Je(o=null){O(o?{hookSpecificOutput:{hookEventName:"SessionStart",additionalContext:o}}:{continue:!0,suppressOutput:!0})}function Ye(o){console.error(`Nebula: ${o}`),O({continue:!0,suppressOutput:!0})}se.exports={readStdin:Ge,writeOutput:O,outputSuccess:Je,outputError:Ye}});var{createClient:He,getOrCreateCollection:Ve,formatSearchContext:We}=V(),{getContainerTag:Ze,getProjectName:Xe}=X(),{loadSettings:Qe,getApiKey:et,debugLog:ce}=re(),{readStdin:tt,writeOutput:F}=ae();async function nt(){let o=Qe();try{let t=(await tt()).cwd||process.cwd(),n=Ze(t),i=Xe(t);ce(o,"SessionStart",{cwd:t,containerTag:n,projectName:i});let r;try{r=et(o)}catch{F({hookSpecificOutput:{hookEventName:"SessionStart",additionalContext:`<nebula-context>
No API key found. Set NEBULA_API_KEY environment variable.
Get your key at: https://trynebula.ai/settings/api-keys
</nebula-context>`}});return}let c=He(r),l=await Ve(c,n,i).catch(()=>n),d=await c.search({query:`${i} recent work context`,collection_ids:[l]}).catch(()=>null),a=d?We(d,o.maxProfileItems):null;F({hookSpecificOutput:{hookEventName:"SessionStart",additionalContext:a||`<nebula-context>
No previous memories found for this project.
Memories will be saved as you work.
</nebula-context>`}})}catch(e){ce(o,"Error",{error:e.message}),F({hookSpecificOutput:{hookEventName:"SessionStart",additionalContext:`<nebula-context>
Failed to load memories: ${e.message}
</nebula-context>`}})}}nt().catch(o=>{console.error(`Nebula fatal: ${o.message}`),process.exit(1)});
