#!/usr/bin/env node
var p=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var S=p((Y,f)=>{var n=require("node:fs"),d=require("node:path"),m=require("node:os"),u=d.join(m.homedir(),".nebula-claude"),i=d.join(u,"credentials.json"),O=process.env.NEBULA_API_URL||"https://api.trynebula.ai";function h(){n.existsSync(u)||n.mkdirSync(u,{recursive:!0})}function L(){try{if(n.existsSync(i)){let e=JSON.parse(n.readFileSync(i,"utf-8"));if(e.apiKey)return e}}catch{}return null}function v(e){h();let t={apiKey:e,savedAt:new Date().toISOString(),apiUrl:O};n.writeFileSync(i,JSON.stringify(t,null,2))}function U(){try{n.existsSync(i)&&n.unlinkSync(i)}catch{}}async function b(e){return!e||typeof e!="string"||e.trim().length===0?{valid:!1,error:"API key must be a non-empty string"}:{valid:!0}}f.exports={SETTINGS_DIR:u,CREDENTIALS_FILE:i,loadCredentials:L,saveCredentials:v,clearCredentials:U,validateApiKey:b}});var N=p((W,g)=>{var c=require("node:fs"),y=require("node:path"),K=require("node:os"),{loadCredentials:P}=S(),a=y.join(K.homedir(),".nebula-claude"),o=y.join(a,"settings.json"),E={skipTools:["Read","Glob","Grep","TodoWrite","AskUserQuestion"],captureTools:["Edit","Write","Bash","Task"],maxProfileItems:5,debug:!1,injectProfile:!0};function k(){c.existsSync(a)||c.mkdirSync(a,{recursive:!0})}function w(){let e={...E};try{if(c.existsSync(o)){let t=c.readFileSync(o,"utf-8");Object.assign(e,JSON.parse(t))}}catch(t){console.error(`Settings: Failed to load ${o}: ${t.message}`)}return process.env.NEBULA_API_KEY&&(e.apiKey=process.env.NEBULA_API_KEY),process.env.NEBULA_SKIP_TOOLS&&(e.skipTools=process.env.NEBULA_SKIP_TOOLS.split(",").map(t=>t.trim())),process.env.NEBULA_DEBUG==="true"&&(e.debug=!0),e}function B(e){k();let t={...e};delete t.apiKey,c.writeFileSync(o,JSON.stringify(t,null,2))}function $(e){if(e.apiKey)return e.apiKey;if(process.env.NEBULA_API_KEY)return process.env.NEBULA_API_KEY;let t=P();if(t?.apiKey)return t.apiKey;throw new Error("NO_API_KEY")}function q(e,t){return t.skipTools.includes(e)?!1:t.captureTools&&t.captureTools.length>0?t.captureTools.includes(e):!0}function x(e,t,r){if(e.debug){let s=new Date().toISOString();console.error(r?`[${s}] ${t}: ${JSON.stringify(r)}`:`[${s}] ${t}`)}}g.exports={SETTINGS_DIR:a,SETTINGS_FILE:o,DEFAULT_SETTINGS:E,loadSettings:w,saveSettings:B,getApiKey:$,shouldCaptureTool:q,debugLog:x}});var _=p((Q,T)=>{async function D(){return new Promise((e,t)=>{let r="";process.stdin.setEncoding("utf8"),process.stdin.on("data",s=>{r+=s}),process.stdin.on("end",()=>{try{e(r.trim()?JSON.parse(r):{})}catch(s){t(new Error(`Failed to parse stdin JSON: ${s.message}`))}}),process.stdin.on("error",t),process.stdin.isTTY&&e({})})}function l(e){console.log(JSON.stringify(e))}function F(e=null){l(e?{hookSpecificOutput:{hookEventName:"SessionStart",additionalContext:e}}:{continue:!0,suppressOutput:!0})}function J(e){console.error(`Nebula: ${e}`),l({continue:!0,suppressOutput:!0})}T.exports={readStdin:D,writeOutput:l,outputSuccess:F,outputError:J}});var{loadSettings:j,debugLog:I}=N(),{readStdin:G,outputSuccess:A}=_();async function C(){let e=j();try{let r=(await G()).session_id;I(e,"UserPromptSubmit",{sessionId:r}),A()}catch(t){I(e,"Error",{error:t.message}),A()}}C().catch(e=>{console.error(`Nebula fatal: ${e.message}`),process.exit(1)});
