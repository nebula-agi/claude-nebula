#!/usr/bin/env node
var xe=Object.create;var V=Object.defineProperty;var ke=Object.getOwnPropertyDescriptor;var Te=Object.getOwnPropertyNames;var Ie=Object.getPrototypeOf,Oe=Object.prototype.hasOwnProperty;var _=(i,e)=>()=>(e||i((e={exports:{}}).exports,e),e.exports);var Re=(i,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Te(e))!Oe.call(i,s)&&s!==t&&V(i,s,{get:()=>e[s],enumerable:!(n=ke(e,s))||n.enumerable});return i};var O=(i,e,t)=>(t=i!=null?xe(Ie(i)):{},Re(e||!i||!i.__esModule?V(t,"default",{value:i,enumerable:!0}):t,i));var te=_(p=>{"use strict";Object.defineProperty(p,"__esModule",{value:!0});var U=(i=>(i.ENTITY="entity",i.RELATIONSHIP="relationship",i.COMMUNITY="community",i))(U||{}),y=class extends Error{constructor(i,e,t){super(i),this.statusCode=e,this.details=t,this.name="NebulaException"}},m=class extends y{constructor(i,e){super(i),this.cause=e,this.name="NebulaClientException"}},W=class extends y{constructor(i="Invalid API key"){super(i,401),this.name="NebulaAuthenticationException"}},X=class extends y{constructor(i="Rate limit exceeded"){super(i,429),this.name="NebulaRateLimitException"}},R=class extends y{constructor(i="Validation error",e){super(i,400),this.details=e,this.name="NebulaValidationException"}},Pe=class extends y{constructor(i="Collection not found"){super(i,404),this.name="NebulaCollectionNotFoundException"}},A=class extends y{constructor(i,e="Resource"){super(`${e} not found: ${i}`,404),this.name="NebulaNotFoundException"}},Z=class Q{constructor(e={}){if(this.apiKey=e.apiKey,!this.apiKey)throw new m("API key is required. Pass it to the constructor or set NEBULA_API_KEY environment variable.");this.baseUrl=(e.baseUrl||"https://api.trynebula.ai").replace(/\/$/,""),this.timeout=e.timeout||3e4}setApiKey(e){this.apiKey=e}setBaseUrl(e){this.baseUrl=(e||this.baseUrl).replace(/\/$/,"")}setCorsProxy(e){}isApiKeySet(){return!!(this.apiKey&&this.apiKey.trim()!=="")}_isNebulaApiKey(e){let t=e||this.apiKey;if(!t)return!1;let n=t.split(".");if(n.length!==2)return!1;let[s,o]=n;return(s.startsWith("key_")||s.startsWith("neb_"))&&!!o&&o.length>0}_buildAuthHeaders(e=!0){let t={};return this._isNebulaApiKey()?t["X-API-Key"]=this.apiKey:t.Authorization=`Bearer ${this.apiKey}`,e&&(t["Content-Type"]="application/json"),t}_isRecord(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)}_unwrapResults(e){return this._isRecord(e)&&"results"in e?e.results:e}_unwrapResultsArray(e){let t=this._unwrapResults(e);return Array.isArray(t)?t:t==null?[]:[t]}_looksLikeMultimodalContent(e){return Array.isArray(e)?e.some(t=>this._isRecord(t)?typeof t.type=="string"||"data"in t||"s3_key"in t||"url"in t:!1):!1}_normalizeContentParts(e){return e.map(t=>typeof t=="string"?{type:"text",text:t}:this._isRecord(t)?typeof t.type=="string"?t:"s3_key"in t&&typeof t.s3_key=="string"?{type:"s3_ref",s3_key:t.s3_key,bucket:typeof t.bucket=="string"?t.bucket:void 0,media_type:typeof t.media_type=="string"?t.media_type:"application/octet-stream",filename:typeof t.filename=="string"?t.filename:void 0,size_bytes:typeof t.size_bytes=="number"?t.size_bytes:void 0}:"data"in t&&typeof t.data=="string"?{type:"file",data:t.data,media_type:typeof t.media_type=="string"?t.media_type:"application/octet-stream",filename:typeof t.filename=="string"?t.filename:void 0,duration_seconds:typeof t.duration_seconds=="number"?t.duration_seconds:void 0}:{type:"text",text:String(t)}:{type:"text",text:String(t)})}async _serializeContentAsText(e){if(this._looksLikeMultimodalContent(e)){let t=this._normalizeContentParts(e),n=await this._processContentParts(t);return JSON.stringify(n)}return typeof e=="object"&&e!==null?JSON.stringify(e):String(e??"")}async _serializeContentAsParts(e){if(!this._looksLikeMultimodalContent(e))return null;let t=this._normalizeContentParts(e);return await this._processContentParts(t)}async _makeRequest(e,t,n,s){let o=new URL(t,this.baseUrl);s&&Object.entries(s).forEach(([a,r])=>{r!=null&&(Array.isArray(r)?r.forEach(d=>{o.searchParams.append(a,String(d))}):o.searchParams.append(a,String(r)))});let l=this._buildAuthHeaders(!0),c=new AbortController,u=setTimeout(()=>c.abort(),this.timeout);try{let a=await fetch(o.toString(),{method:e,headers:l,body:n?JSON.stringify(n):void 0,signal:c.signal});if(clearTimeout(u),a.status===200||a.status===202)return await a.json();if(a.status===401)throw new W("Invalid API key");if(a.status===429)throw new X("Rate limit exceeded");if(a.status===400){let r=await a.json().catch(()=>({}));throw new R(r.message||"Validation error",r.details)}else if(a.status===422){let r=await a.json().catch(()=>({}));throw console.error("[SDK] 422 Validation error - Full details:"),console.error("  Status:",a.status),console.error("  Error data:",JSON.stringify(r,null,2)),console.error("  Message:",r.message),console.error("  Detail:",r.detail),new R(r.message||(typeof r.detail=="string"?r.detail:JSON.stringify(r.detail))||"Validation error",r)}else{let r=await a.json().catch(()=>({}));throw new y(r.message||`API error: ${a.status}`,a.status,r)}}catch(a){throw clearTimeout(u),a instanceof y?a:a instanceof Error&&a.name==="AbortError"?new m(`Request timed out after ${this.timeout} milliseconds`):a instanceof Error?new m(`Request failed: ${a.message}`,a):new m(`Request failed: ${String(a)}`)}}async createCollection(e){let t={name:e.name};e.description&&(t.description=e.description),e.metadata&&(t.metadata=e.metadata);let n=await this._makeRequest("POST","/v1/collections",t),s=n.results||n;return this._collectionFromDict(s)}async getCollection(e){let t=await this._makeRequest("GET",`/v1/collections/${e}`),n=t.results||t;return this._collectionFromDict(n)}async getCollectionByName(e){let t=await this._makeRequest("GET",`/v1/collections/name/${e}`),n=t.results||t;return this._collectionFromDict(n)}async listCollections(e){let t={limit:e?.limit??100,offset:e?.offset??0};e?.name!==void 0&&(t.name=e.name);let n=await this._makeRequest("GET","/v1/collections",void 0,t),s;return typeof n=="object"&&n!==null&&"results"in n?s=n.results:Array.isArray(n)?s=n:s=[n],s.map(o=>this._collectionFromDict(o))}async updateCollection(e){let t={};e.name!==void 0&&(t.name=e.name),e.description!==void 0&&(t.description=e.description),e.metadata!==void 0&&(t.metadata=e.metadata);let n=await this._makeRequest("POST",`/v1/collections/${e.collectionId}`,t),s=n.results||n;return this._collectionFromDict(s)}async deleteCollection(e){return await this._makeRequest("DELETE",`/v1/collections/${e}`),!0}async store(e,t,n={}){let s={...n,memory_type:"memory",timestamp:new Date().toISOString()},o={collection_id:t,raw_text:String(e||""),metadata:s,ingestion_mode:"fast"},l=await this._makeRequest("POST","/v1/memories",o),c=l?.results?.engram_id||l?.results?.id||l?.id||"",u=s.timestamp;return{id:String(c),memory_id:String(c),content:String(e||""),metadata:s,collection_ids:[t],created_at:u,updated_at:u}}async storeMemory(e,t){let n;if("collection_id"in e)n=e;else{let d=e;n={collection_id:d.collection_id||d.collectionId||"",content:d.content||"",role:d.role,memory_id:d.memory_id||d.memoryId||void 0,metadata:d.metadata||{}}}if(n.memory_id)return await this._appendToMemory(n.memory_id,n);if((n.role?"conversation":"document")==="conversation"){let d=[];if(n.content&&n.role){let I=await this._serializeContentAsParts(n.content)??await this._serializeContentAsText(n.content),v=n;d.push({content:I,role:n.role,metadata:n.metadata||{},...typeof v.authority=="number"?{authority:Number(v.authority)}:{}})}if(d.length===0)throw new m("Cannot create conversation without messages. Provide content and role.");let f={collection_id:n.collection_id,name:t||"Conversation",messages:d,metadata:n.metadata||{}},h=await this._makeRequest("POST","/v1/memories",f);if(h.results){let S=h.results.memory_id||h.results.id;if(!S)throw new m("Failed to create conversation: no id returned");return String(S)}throw new m("Failed to create conversation: invalid response format")}let o={...n.metadata};o.memory_type="memory";let l=n;if(typeof l.authority=="number"){let d=Number(l.authority);!Number.isNaN(d)&&d>=0&&d<=1&&(o.authority=d)}let c,u=await this._serializeContentAsParts(n.content);if(u)c={collection_id:n.collection_id,content_parts:u,metadata:o,ingestion_mode:"fast"};else if(Array.isArray(n.content)&&n.content.every(d=>typeof d=="string"))c={collection_id:n.collection_id,chunks:n.content,metadata:o,ingestion_mode:"fast"};else{let d=await this._serializeContentAsText(n.content);if(!d||d==='""'||d==="[]"||d==="{}")throw new m("Content is required for document memories");c={collection_id:n.collection_id,raw_text:d,metadata:o,ingestion_mode:"fast"}}let a=await this._makeRequest("POST","/v1/memories",c),r=a?.results?.engram_id||a?.results?.id||a?.id||"";return String(r||"")}async _appendToMemory(e,t){let n=t.collection_id,s=t.content,o=t.metadata;if(!n)throw new m("collection_id is required");let l={collection_id:n};if(Array.isArray(s))s.length>0&&typeof s[0]=="object"&&"content"in s[0]?l.messages=s:l.chunks=s;else if(typeof s=="string")l.raw_text=s;else throw new m("content must be a string, array of strings, or array of message objects");o&&(l.metadata=o);try{return await this._makeRequest("POST",`/v1/memories/${e}/append`,l),e}catch(c){throw c instanceof y&&c.statusCode===404?new A(e,"Memory"):c}}async storeMemories(e){let t=[],n={},s=[];for(let o of e)if(o.role){let l=o.memory_id||`__new__::${o.collection_id}`;n[l]||(n[l]=[]),n[l].push(o)}else s.push(o);for(let[o,l]of Object.entries(n)){let c=l[0].collection_id,u,a=[];for(let r of l){let f=await this._serializeContentAsParts(r.content)??await this._serializeContentAsText(r.content);if(typeof f=="string"){if(!f.trim())continue}else if(f.length===0)continue;let h=r;a.push({content:f,role:r.role,metadata:r.metadata||{},...typeof h.authority=="number"?{authority:Number(h.authority)}:{}})}if(!a.length)throw new m("Cannot create/append conversation without messages. Provide non-empty content.");if(o.startsWith("__new__::")){let r={collection_id:c,name:"Conversation",messages:a,metadata:{}},d=await this._makeRequest("POST","/v1/memories",r);if(d.results){if(u=d.results.memory_id||d.results.id||"",!u)throw new m("Failed to create conversation: no id returned")}else throw new m("Failed to create conversation: invalid response format")}else{u=o;let r={collection_id:c,content:a,memory_id:u,metadata:{}};await this._appendToMemory(u,r)}t.push(...Array(l.length).fill(String(u)))}for(let o of s)t.push(await this.storeMemory(o));return t}async delete(e){try{if(console.log("[SDK] delete() called with:",{memoryIds:e,type:typeof e,isArray:Array.isArray(e)}),typeof e=="string"){console.log("[SDK] Single deletion path for ID:",e);try{return await this._makeRequest("DELETE",`/v1/memories/${e}`),!0}catch{console.log("[SDK] Falling back to POST /v1/memories/delete with single ID");let t=await this._makeRequest("POST","/v1/memories/delete",e);return typeof t=="object"&&t.success!==void 0?t.success:!0}}else{console.log("[SDK] Batch deletion path for IDs:",e),console.log("[SDK] Sending POST request with body:",e);let t=await this._makeRequest("POST","/v1/memories/delete",e);return console.log("[SDK] Batch deletion response:",t),t}}catch(t){throw console.error("[SDK] Delete error:",t),t instanceof Error?t:new m(`Unknown error: ${String(t)}`)}}async deleteChunk(e){try{return await this._makeRequest("DELETE",`/v1/chunks/${e}`),!0}catch(t){throw t instanceof y&&t.statusCode===404?new A(e,"Chunk"):t}}async updateChunk(e,t,n){let s={content:t};n!==void 0&&(s.metadata=n);try{return await this._makeRequest("PATCH",`/v1/chunks/${e}`,s),!0}catch(o){throw o instanceof y&&o.statusCode===404?new A(e,"Chunk"):o}}async updateMemory(e){let t={};if(e.name!==void 0&&(t.name=e.name),e.metadata!==void 0&&(t.metadata=e.metadata,t.merge_metadata=e.mergeMetadata??!1),e.collectionIds!==void 0&&(t.collection_ids=e.collectionIds),Object.keys(t).length===0)throw new R("At least one field (name, metadata, or collectionIds) must be provided to update");try{return await this._makeRequest("PATCH",`/v1/memories/${e.memoryId}`,t),!0}catch(n){throw n instanceof y&&n.statusCode===404?new A(e.memoryId,"Memory"):n}}async listMemories(e){let t=Array.isArray(e.collection_ids)?e.collection_ids:[e.collection_ids];if(!t.length)throw new m("collection_ids must be provided to list_memories().");let n={limit:e.limit??100,offset:e.offset??0,collection_ids:t};e.metadata_filters&&(n.metadata_filters=JSON.stringify(e.metadata_filters));let s=await this._makeRequest("GET","/v1/memories",void 0,n),o;return typeof s=="object"&&s!==null&&"results"in s?o=s.results:Array.isArray(s)?o=s:o=[s],o.map(l=>this._memoryResponseFromDict(l,t))}async getMemory(e){let t=await this._makeRequest("GET",`/v1/memories/${e}`),n=t.text||t.content,s=Array.isArray(t.chunks)?t.chunks:void 0,o={id:t.id,content:n,chunks:s,metadata:t.metadata||{},collection_ids:t.collection_ids||[]};return this._memoryResponseFromDict(o,[])}async search(e){let t={query:e.query};if(e.effort&&(t.effort=e.effort),e.collection_ids){let c=(Array.isArray(e.collection_ids)?e.collection_ids:[e.collection_ids]).filter(u=>u&&u.trim()!=="");c.length&&(t.collection_ids=c)}e.filters&&(t.filters=e.filters),e.searchSettings&&(t.search_settings=e.searchSettings);let s=(await this._makeRequest("POST","/v1/memories/search",t)).results;return{query:s.query||e.query,entities:s.entities||[],facts:s.facts||[],utterances:s.utterances||[],inference_hints:s.inference_hints||[],fact_to_chunks:s.fact_to_chunks||{},entity_to_facts:s.entity_to_facts||{},retrieved_at:s.retrieved_at||new Date().toISOString(),focus:s.focus,total_traversal_time_ms:s.total_traversal_time_ms,query_intent:s.query_intent}}async healthCheck(){return this._makeRequest("GET","/v1/health")}_collectionFromDict(e){let t;e.created_at&&(typeof e.created_at=="string"?t=e.created_at:e.created_at instanceof Date&&(t=e.created_at.toISOString()));let n;e.updated_at&&(typeof e.updated_at=="string"?n=e.updated_at:e.updated_at instanceof Date&&(n=e.updated_at.toISOString()));let s=String(e.id||""),o=String(e.name||""),l=typeof e.description=="string"?e.description:void 0,c=e.owner_id?String(e.owner_id):void 0,u=typeof e.memory_count=="number"?e.memory_count:0,a={graph_collection_status:String(e.graph_collection_status||""),graph_sync_status:String(e.graph_sync_status||""),user_count:typeof e.user_count=="number"?e.user_count:0};return{id:s,name:o,description:l,metadata:a,created_at:t,updated_at:n,memory_count:u,owner_id:c}}_memoryResponseFromDict(e,t){let n;e.created_at&&(typeof e.created_at=="string"?n=e.created_at:e.created_at instanceof Date&&(n=e.created_at.toISOString()));let s;e.updated_at&&(typeof e.updated_at=="string"?s=e.updated_at:e.updated_at instanceof Date&&(s=e.updated_at.toISOString()));let o=String(e.id||""),l=typeof e.content=="string"?e.content:typeof e.text=="string"?e.text:void 0,c;e.chunks&&Array.isArray(e.chunks)&&(e.chunks.every(r=>typeof r=="string")?c=e.chunks.map(r=>({id:"",content:r,metadata:{}})):c=e.chunks.filter(r=>r&&typeof r=="object"&&("text"in r||"content"in r)).map(r=>({id:String(r.id||""),content:String(r.text||r.content||""),metadata:typeof r.metadata=="object"&&r.metadata!==null?r.metadata:{},role:typeof r.role=="string"?r.role:void 0})));let u={...typeof e.metadata=="object"&&e.metadata!==null?e.metadata:{}};e.engram_id&&(u.engram_id=e.engram_id);let a=o;return e.engram_id&&!o&&(a=String(e.engram_id)),e.document_metadata&&typeof e.document_metadata=="object"&&Object.assign(u,e.document_metadata),{id:a,memory_id:a,content:l,chunks:c,metadata:u,collection_ids:Array.isArray(e.collection_ids)?e.collection_ids:t,created_at:n,updated_at:s}}_searchResultFromDict(e){let t=typeof e.content=="string"?e.content:typeof e.text=="string"?e.text:"",n=String(e.id||e.chunk_id||"");return{id:String(n),content:String(t),score:typeof e.score=="number"?e.score:Number(e.score||0),metadata:typeof e.metadata=="object"&&e.metadata!==null?e.metadata:{},source:typeof e.source=="string"?e.source:void 0}}_searchResultFromGraphDict(e){let t=e.id?String(e.id):"",n=typeof e.result_type=="string"?e.result_type:"entity",s=U[n.toUpperCase()]||"entity",o=typeof e.content=="object"&&e.content!==null?e.content:{},l=e.score!==void 0?Number(e.score):0,c=typeof e.metadata=="object"&&e.metadata!==null?e.metadata:{},u=Array.isArray(e.chunk_ids)?e.chunk_ids:void 0,a;if(e.timestamp)if(typeof e.timestamp=="string")a=e.timestamp;else if(e.timestamp instanceof Date)a=e.timestamp.toISOString();else{let H=new Date(String(e.timestamp));Number.isNaN(H.valueOf())||(a=H.toISOString())}let r=typeof e.display_name=="string"?e.display_name:void 0,d=typeof e.source_role=="string"?e.source_role:void 0,f=e.engram_id?String(e.engram_id):void 0,h=e.owner_id?String(e.owner_id):void 0,S,I,v;return s==="entity"?S={id:o.id?String(o.id):void 0,name:String(o.name||""),description:String(o.description||""),metadata:typeof o.metadata=="object"&&o.metadata!==null?o.metadata:{}}:s==="relationship"?I={id:o.id?String(o.id):void 0,subject:String(o.subject||""),predicate:String(o.predicate||""),object:String(o.object||""),subject_id:o.subject_id?String(o.subject_id):void 0,object_id:o.object_id?String(o.object_id):void 0,description:typeof o.description=="string"?o.description:void 0,metadata:typeof o.metadata=="object"&&o.metadata!==null?o.metadata:{}}:v={id:o.id?String(o.id):void 0,name:String(o.name||""),summary:String(o.summary||""),metadata:typeof o.metadata=="object"&&o.metadata!==null?o.metadata:{}},{id:t,score:l,metadata:c,source:"graph",content:void 0,graph_result_type:s,graph_entity:S,graph_relationship:I,graph_community:v,chunk_ids:u,timestamp:a,display_name:r,source_role:d,engram_id:f,owner_id:h}}async _sha256(e){let t=new TextEncoder().encode(e),n;typeof globalThis.crypto<"u"&&globalThis.crypto.subtle?n=globalThis.crypto:n=(await import("crypto")).webcrypto;let s=await n.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(s)).map(c=>c.toString(16).padStart(2,"0")).join("")}_formDataFromObject(e){let t=new FormData;return Object.entries(e).forEach(([n,s])=>{t.append(n,s)}),t}async _processContentParts(e){let t=[];for(let n of e){if(n.type!=="text"&&n.type!=="s3_ref"&&"data"in n&&n.data){let s=n,o=Math.floor(String(s.data).length*3/4);if(o>Q.MAX_INLINE_SIZE){let l=s.filename||"file.bin",c=s.media_type||"application/octet-stream",u=await this.getUploadUrl({filename:l,content_type:c,file_size:o}),a,r=globalThis.atob;if(typeof r=="function"){let d=r(String(s.data));a=new Uint8Array(d.length);for(let f=0;f<d.length;f++)a[f]=d.charCodeAt(f)}else{let{Buffer:d}=await import("buffer");a=Uint8Array.from(d.from(String(s.data),"base64"))}await fetch(u.upload_url,{method:"PUT",body:a,headers:{"Content-Type":c}}),t.push({type:"s3_ref",s3_key:u.s3_key,media_type:c,filename:l});continue}}t.push(n)}return t}async getUploadUrl(e){let t=await this._makeRequest("POST","/v1/memories/upload",void 0,{filename:e.filename,content_type:e.content_type,file_size:e.file_size});return t.results?t.results:t}};Z.MAX_INLINE_SIZE=5*1024*1024;var ee=Z,je={".jpg":"image/jpeg",".jpeg":"image/jpeg",".png":"image/png",".gif":"image/gif",".webp":"image/webp",".heic":"image/heic",".bmp":"image/bmp",".tiff":"image/tiff",".mp3":"audio/mpeg",".wav":"audio/wav",".m4a":"audio/m4a",".ogg":"audio/ogg",".flac":"audio/flac",".aac":"audio/aac",".webm":"audio/webm",".pdf":"application/pdf",".doc":"application/msword",".docx":"application/vnd.openxmlformats-officedocument.wordprocessingml.document",".xls":"application/vnd.ms-excel",".xlsx":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",".ppt":"application/vnd.ms-powerpoint",".pptx":"application/vnd.openxmlformats-officedocument.presentationml.presentation",".txt":"text/plain",".csv":"text/csv",".rtf":"application/rtf",".epub":"application/epub+zip"},M=class{static async fromFile(i,e){let t,n;try{t=await import("fs/promises"),n=await import("path")}catch{throw new Error("File system operations are only supported in Node.js environments.")}let s=n.resolve(i),o=n.basename(s),l=n.extname(s).toLowerCase(),c=e||je[l]||"application/octet-stream";return{data:(await t.readFile(s)).toString("base64"),media_type:c,filename:o}}},De=i=>i,qe=Object.assign(De,{File:M.fromFile,async fromFile(i,e,t,n){return{collection_id:e,content:[await M.fromFile(i)],metadata:t||{},role:n}}});p.GraphSearchResultType=U;p.Memory=qe;p.Nebula=ee;p.NebulaAuthenticationException=W;p.NebulaClientException=m;p.NebulaCollectionNotFoundException=Pe;p.NebulaContent=M;p.NebulaException=y;p.NebulaNotFoundException=A;p.NebulaRateLimitException=X;p.NebulaValidationException=R;p.default=ee});var se=_((Dt,ne)=>{var{Nebula:Fe}=te(),$e="claudecode_default",K=class{constructor(e,t){if(!e)throw new Error("NEBULA_API_KEY is required");this.client=new Fe({apiKey:e}),this.collectionId=t||$e}async addMemory(e,t,n={},s=null){let o={collection_id:t||this.collectionId,content:e,metadata:{source:"claude-nebula-plugin",timestamp:new Date().toISOString(),...n}};return s&&(o.id=s),{id:await this.client.storeMemory(o),status:"success",collectionId:t||this.collectionId}}async search(e,t,n={}){let s={query:e,collection_ids:[t||this.collectionId],limit:n.limit||10},o=await this.client.search(s),l=o.utterances||[];return{results:l.map(c=>({id:c.chunk_id||c.engram_id,memory:c.text||"",similarity:c.activation_score||0,title:c.display_name,content:c.text||"",timestamp:c.timestamp})),total:l.length,timing:o.total_traversal_time_ms,entities:o.entities||[],facts:o.facts||[]}}async getProfile(e,t){let n=e||this.collectionId;try{let s=await this.search(t||"user profile preferences recent work",n,{limit:15}),o=s.results,l=s.entities.filter(u=>u.entity_category==="idea"||u.entity_name.toLowerCase().includes("user")).slice(0,5).map(u=>u.profile?.entity?.description||u.entity_name).filter(Boolean),c=s.facts.slice(0,5).map(u=>`${u.subject} ${u.predicate} ${u.object_value}`).filter(Boolean);return{profile:{static:l,dynamic:c},searchResults:o.length>0?s:void 0}}catch(s){return console.warn("Profile search failed:",s.message),{profile:{static:[],dynamic:[]},searchResults:void 0}}}async listMemories(e,t=20){return{memories:(await this.search("recent work memories",e,{limit:t})).results.map(s=>({id:s.id,content:s.memory,similarity:s.similarity,createdAt:s.timestamp}))}}async deleteMemory(e){try{return await this.client.deleteMemory(e),{success:!0,id:e}}catch(t){return console.warn("Nebula DELETE operation failed:",t.message),{success:!1,error:t.message,id:e}}}async createCollection(e,t={}){let n={name:e,metadata:{source:"claude-code-plugin",created_at:new Date().toISOString(),...t}},s=await this.client.createCollection(n);return{id:s.id||s.collection_id||e,name:s.name||e}}};ne.exports={NebulaClient:K}});var re=_((qt,oe)=>{var E=require("node:fs"),ie=require("node:path"),Le=require("node:os"),j=ie.join(Le.homedir(),".nebula-claude"),P=ie.join(j,"collections.json"),z=class{constructor(e){this.client=e,this.cache=this._loadCache()}_ensureDir(){E.existsSync(j)||E.mkdirSync(j,{recursive:!0})}_loadCache(){try{if(E.existsSync(P)){let e=E.readFileSync(P,"utf-8");return JSON.parse(e)}}catch(e){console.error(`Failed to load collections cache: ${e.message}`)}return{}}_saveCache(){this._ensureDir();try{E.writeFileSync(P,JSON.stringify(this.cache,null,2))}catch(e){console.error(`Failed to save collections cache: ${e.message}`)}}_generateFriendlyName(e,t){return t&&t!==e?t.replace(/[^a-zA-Z0-9-_]/g,"_").toLowerCase():`project_${e.substring(0,8)}`}async getOrCreateCollection(e,t=null){if(this.cache[e])return this.cache[e];let n=this._generateFriendlyName(e,t);try{let s=await this.client.createCollection(n,{container_tag:e,project_name:t}),o={id:s.id,name:s.name||n,containerTag:e,createdAt:new Date().toISOString()};return this.cache[e]=o,this._saveCache(),o}catch(s){if(s.message.includes("409")||s.message.includes("exists")){console.warn(`Collection ${n} already exists, using name as ID`);let o={id:n,name:n,containerTag:e,createdAt:new Date().toISOString()};return this.cache[e]=o,this._saveCache(),o}throw new Error(`Failed to create collection: ${s.message}`)}}getCollectionId(e){return this.cache[e]?.id||null}clearCache(){this.cache={},this._saveCache()}};oe.exports={CollectionManager:z,SETTINGS_DIR:j,COLLECTIONS_FILE:P}});var le=_((Ft,ce)=>{var{execSync:ae}=require("node:child_process"),Me=require("node:crypto");function D(i){return Me.createHash("sha256").update(i).digest("hex").slice(0,16)}function B(i){try{return ae("git rev-parse --show-toplevel",{cwd:i,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim()||null}catch{return null}}function Ue(i){let t=B(i)||i;return`claudecode_project_${D(t)}`}function Ke(i){return(B(i)||i).split("/").pop()||"unknown"}function ze(){try{let e=ae("git config user.email",{encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim();if(e)return`claudecode_user_${D(e)}`}catch{}let i=process.env.USER||process.env.USERNAME||"anonymous";return`claudecode_user_${D(i)}`}function Be(i,e){return e&&e!=="unknown"?e.replace(/[^a-zA-Z0-9-_]/g,"_").toLowerCase():`project_${i.replace("claudecode_project_","")}`}ce.exports={sha256:D,getGitRoot:B,getContainerTag:Ue,getProjectName:Ke,getUserContainerTag:ze,getCollectionName:Be}});var me=_(($t,de)=>{var g=require("node:fs"),ue=require("node:path"),Je=require("node:os"),q=ue.join(Je.homedir(),".nebula-claude"),b=ue.join(q,"credentials.json"),Ge=process.env.NEBULA_API_URL||"https://api.trynebula.ai";function Ye(){g.existsSync(q)||g.mkdirSync(q,{recursive:!0})}function He(){try{if(g.existsSync(b)){let i=JSON.parse(g.readFileSync(b,"utf-8"));if(i.apiKey)return i}}catch{}return null}function Ve(i){Ye();let e={apiKey:i,savedAt:new Date().toISOString(),apiUrl:Ge};g.writeFileSync(b,JSON.stringify(e,null,2))}function We(){try{g.existsSync(b)&&g.unlinkSync(b)}catch{}}async function Xe(i){return!i||typeof i!="string"||i.trim().length===0?{valid:!1,error:"API key must be a non-empty string"}:{valid:!0}}de.exports={SETTINGS_DIR:q,CREDENTIALS_FILE:b,loadCredentials:He,saveCredentials:Ve,clearCredentials:We,validateApiKey:Xe}});var he=_((Lt,ye)=>{var C=require("node:fs"),fe=require("node:path"),Ze=require("node:os"),{loadCredentials:Qe}=me(),F=fe.join(Ze.homedir(),".nebula-claude"),N=fe.join(F,"settings.json"),pe={skipTools:["Read","Glob","Grep","TodoWrite","AskUserQuestion"],captureTools:["Edit","Write","Bash","Task"],maxProfileItems:5,debug:!1,injectProfile:!0};function et(){C.existsSync(F)||C.mkdirSync(F,{recursive:!0})}function tt(){let i={...pe};try{if(C.existsSync(N)){let e=C.readFileSync(N,"utf-8");Object.assign(i,JSON.parse(e))}}catch(e){console.error(`Settings: Failed to load ${N}: ${e.message}`)}return process.env.NEBULA_API_KEY&&(i.apiKey=process.env.NEBULA_API_KEY),process.env.NEBULA_SKIP_TOOLS&&(i.skipTools=process.env.NEBULA_SKIP_TOOLS.split(",").map(e=>e.trim())),process.env.NEBULA_DEBUG==="true"&&(i.debug=!0),i}function nt(i){et();let e={...i};delete e.apiKey,C.writeFileSync(N,JSON.stringify(e,null,2))}function st(i){if(i.apiKey)return i.apiKey;if(process.env.NEBULA_API_KEY)return process.env.NEBULA_API_KEY;let e=Qe();if(e?.apiKey)return e.apiKey;throw new Error("NO_API_KEY")}function it(i,e){return e.skipTools.includes(i)?!1:e.captureTools&&e.captureTools.length>0?e.captureTools.includes(i):!0}function ot(i,e,t){if(i.debug){let n=new Date().toISOString();console.error(t?`[${n}] ${e}: ${JSON.stringify(t)}`:`[${n}] ${e}`)}}ye.exports={SETTINGS_DIR:F,SETTINGS_FILE:N,DEFAULT_SETTINGS:pe,loadSettings:tt,saveSettings:nt,getApiKey:st,shouldCaptureTool:it,debugLog:ot}});var ge=_((Mt,_e)=>{async function rt(){return new Promise((i,e)=>{let t="";process.stdin.setEncoding("utf8"),process.stdin.on("data",n=>{t+=n}),process.stdin.on("end",()=>{try{i(t.trim()?JSON.parse(t):{})}catch(n){e(new Error(`Failed to parse stdin JSON: ${n.message}`))}}),process.stdin.on("error",e),process.stdin.isTTY&&i({})})}function $(i){console.log(JSON.stringify(i))}function at(i=null){$(i?{hookSpecificOutput:{hookEventName:"SessionStart",additionalContext:i}}:{continue:!0,suppressOutput:!0})}function ct(i){console.error(`Nebula: ${i}`),$({continue:!0,suppressOutput:!0})}_e.exports={readStdin:rt,writeOutput:$,outputSuccess:at,outputError:ct}});var Ce=_((Ut,Ne)=>{var w=require("node:fs"),J=require("node:path"),lt=require("node:os"),ut=500,dt=["Read"],L=J.join(lt.homedir(),".nebula-claude","trackers"),G=new Map;function we(){w.existsSync(L)||w.mkdirSync(L,{recursive:!0})}function Se(i){we();let e=J.join(L,`${i}.txt`);return w.existsSync(e)?w.readFileSync(e,"utf-8").trim():null}function be(i,e){we();let t=J.join(L,`${i}.txt`);w.writeFileSync(t,e)}function ve(i){if(!w.existsSync(i))return[];let t=w.readFileSync(i,"utf-8").trim().split(`
`),n=[];for(let s of t)if(s.trim())try{n.push(JSON.parse(s))}catch{}return n}function Ae(i,e){if(!e)return i.filter(s=>s.type==="user"||s.type==="assistant");let t=!1,n=[];for(let s of i){if(s.uuid===e){t=!0;continue}t&&(s.type==="user"||s.type==="assistant")&&n.push(s)}return n}function Ee(i){let e=[];if(i.type==="user"){let t=mt(i.message);t&&e.push(t)}else if(i.type==="assistant"){let t=ft(i.message);t&&e.push(t)}return e.join(`
`)}function mt(i){if(!i?.content)return null;let e=i.content,t=[];if(typeof e=="string"){let n=x(e);n&&t.push(`[role:user]
${n}
[user:end]`)}else if(Array.isArray(e)){for(let n of e)if(n.type==="text"&&n.text){let s=x(n.text);s&&t.push(`[role:user]
${s}
[user:end]`)}else if(n.type==="tool_result"){let s=n.tool_use_id||"",o=G.get(s)||"Unknown";if(dt.includes(o))continue;let l=Y(x(n.content||""),ut),c=n.is_error?"error":"success";l&&t.push(`[tool_result:${o} status="${c}"]
${l}
[tool_result:end]`)}}return t.length>0?t.join(`

`):null}function ft(i){if(!i?.content)return null;let e=i.content,t=[];if(!Array.isArray(e))return null;for(let n of e)if(n.type!=="thinking"){if(n.type==="text"&&n.text){let s=x(n.text);s&&t.push(`[role:assistant]
${s}
[assistant:end]`)}else if(n.type==="tool_use"){let s=n.name||"Unknown",o=n.id||"",l=n.input||{},c=pt(l);t.push(`[tool:${s}]
${c}
[tool:end]`),o&&G.set(o,s)}}return t.length>0?t.join(`

`):null}function pt(i){let e=[];for(let[t,n]of Object.entries(i)){let s=typeof n=="string"?n:JSON.stringify(n);s=Y(s,200),e.push(`${t}: ${s}`)}return e.join(`
`)}function x(i){return!i||typeof i!="string"?"":i.replace(/<system-reminder>[\s\S]*?<\/system-reminder>/g,"").replace(/<nebula-context>[\s\S]*?<\/nebula-context>/g,"").trim()}function Y(i,e){return!i||i.length<=e?i:`${i.slice(0,e)}...`}function yt(i,e){G=new Map;let t=ve(i);if(t.length===0)return null;let n=Se(e),s=Ae(t,n);if(s.length===0)return null;let o=s[0],l=s[s.length-1],c=o.timestamp||new Date().toISOString(),u=[];u.push(`[turn:start timestamp="${c}"]`);for(let r of s){let d=Ee(r);d&&u.push(d)}u.push("[turn:end]");let a=u.join(`

`);return a.length<100?null:(be(e,l.uuid),a)}Ne.exports={parseTranscript:ve,getEntriesSinceLastCapture:Ae,formatEntry:Ee,formatNewEntries:yt,cleanContent:x,truncate:Y,getLastCapturedUuid:Se,setLastCapturedUuid:be}});var{NebulaClient:ht}=se(),{CollectionManager:_t}=re(),{getContainerTag:gt,getProjectName:wt}=le(),{loadSettings:St,getApiKey:bt,debugLog:k}=he(),{readStdin:vt,writeOutput:T}=ge(),{formatNewEntries:At}=Ce();async function Et(){let i=St();try{let e=await vt(),t=e.cwd||process.cwd(),n=e.session_id,s=e.transcript_path;if(k(i,"Stop",{sessionId:n,transcriptPath:s}),!s||!n){k(i,"Missing transcript path or session id"),T({continue:!0});return}let o;try{o=bt(i)}catch{T({continue:!0});return}let l=At(s,n);if(!l){k(i,"No new content to save"),T({continue:!0});return}let c=new ht(o),u=new _t(c),a=gt(t),r=wt(t),f=(await u.getOrCreateCollection(a,r).catch(()=>null))?.id||a;await c.addMemory(l,f,{memory_type:"conversation",type:"session_turn",project:r,timestamp:new Date().toISOString()},n),k(i,"Session turn saved",{length:l.length}),T({continue:!0})}catch(e){k(i,"Error",{error:e.message}),console.error(`Nebula: ${e.message}`),T({continue:!0})}}Et().catch(i=>{console.error(`Nebula fatal: ${i.message}`),process.exit(1)});
