#!/usr/bin/env node
var Ne=Object.create;var G=Object.defineProperty;var Ee=Object.getOwnPropertyDescriptor;var Ce=Object.getOwnPropertyNames;var ke=Object.getPrototypeOf,Ie=Object.prototype.hasOwnProperty;var g=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var Te=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of Ce(e))!Ie.call(r,o)&&o!==t&&G(r,o,{get:()=>e[o],enumerable:!(n=Ee(e,o))||n.enumerable});return r};var T=(r,e,t)=>(t=r!=null?Ne(ke(r)):{},Te(e||!r||!r.__esModule?G(t,"default",{value:r,enumerable:!0}):t,r));var X=g(y=>{"use strict";Object.defineProperty(y,"__esModule",{value:!0});var L=(r=>(r.ENTITY="entity",r.RELATIONSHIP="relationship",r.COMMUNITY="community",r))(L||{}),_=class extends Error{constructor(r,e,t){super(r),this.statusCode=e,this.details=t,this.name="NebulaException"}},p=class extends _{constructor(r,e){super(r),this.cause=e,this.name="NebulaClientException"}},Y=class extends _{constructor(r="Invalid API key"){super(r,401),this.name="NebulaAuthenticationException"}},H=class extends _{constructor(r="Rate limit exceeded"){super(r,429),this.name="NebulaRateLimitException"}},R=class extends _{constructor(r="Validation error",e){super(r,400),this.details=e,this.name="NebulaValidationException"}},Re=class extends _{constructor(r="Collection not found"){super(r,404),this.name="NebulaCollectionNotFoundException"}},x=class extends _{constructor(r,e="Resource"){super(`${e} not found: ${r}`,404),this.name="NebulaNotFoundException"}},V=class W{constructor(e={}){if(this.apiKey=e.apiKey,!this.apiKey)throw new p("API key is required. Pass it to the constructor or set NEBULA_API_KEY environment variable.");this.baseUrl=(e.baseUrl||"https://api.trynebula.ai").replace(/\/$/,""),this.timeout=e.timeout||3e4}setApiKey(e){this.apiKey=e}setBaseUrl(e){this.baseUrl=(e||this.baseUrl).replace(/\/$/,"")}setCorsProxy(e){}isApiKeySet(){return!!(this.apiKey&&this.apiKey.trim()!=="")}_isNebulaApiKey(e){let t=e||this.apiKey;if(!t)return!1;let n=t.split(".");if(n.length!==2)return!1;let[o,i]=n;return(o.startsWith("key_")||o.startsWith("neb_"))&&!!i&&i.length>0}_buildAuthHeaders(e=!0){let t={};return this._isNebulaApiKey()?t["X-API-Key"]=this.apiKey:t.Authorization=`Bearer ${this.apiKey}`,e&&(t["Content-Type"]="application/json"),t}_isRecord(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)}_unwrapResults(e){return this._isRecord(e)&&"results"in e?e.results:e}_unwrapResultsArray(e){let t=this._unwrapResults(e);return Array.isArray(t)?t:t==null?[]:[t]}_looksLikeMultimodalContent(e){return Array.isArray(e)?e.some(t=>this._isRecord(t)?typeof t.type=="string"||"data"in t||"s3_key"in t||"url"in t:!1):!1}_normalizeContentParts(e){return e.map(t=>typeof t=="string"?{type:"text",text:t}:this._isRecord(t)?typeof t.type=="string"?t:"s3_key"in t&&typeof t.s3_key=="string"?{type:"s3_ref",s3_key:t.s3_key,bucket:typeof t.bucket=="string"?t.bucket:void 0,media_type:typeof t.media_type=="string"?t.media_type:"application/octet-stream",filename:typeof t.filename=="string"?t.filename:void 0,size_bytes:typeof t.size_bytes=="number"?t.size_bytes:void 0}:"data"in t&&typeof t.data=="string"?{type:"file",data:t.data,media_type:typeof t.media_type=="string"?t.media_type:"application/octet-stream",filename:typeof t.filename=="string"?t.filename:void 0,duration_seconds:typeof t.duration_seconds=="number"?t.duration_seconds:void 0}:{type:"text",text:String(t)}:{type:"text",text:String(t)})}async _serializeContentAsText(e){if(this._looksLikeMultimodalContent(e)){let t=this._normalizeContentParts(e),n=await this._processContentParts(t);return JSON.stringify(n)}return typeof e=="object"&&e!==null?JSON.stringify(e):String(e??"")}async _serializeContentAsParts(e){if(!this._looksLikeMultimodalContent(e))return null;let t=this._normalizeContentParts(e);return await this._processContentParts(t)}async _makeRequest(e,t,n,o){let i=new URL(t,this.baseUrl);o&&Object.entries(o).forEach(([s,a])=>{a!=null&&(Array.isArray(a)?a.forEach(d=>{i.searchParams.append(s,String(d))}):i.searchParams.append(s,String(a)))});let c=this._buildAuthHeaders(!0),l=new AbortController,u=setTimeout(()=>l.abort(),this.timeout);try{let s=await fetch(i.toString(),{method:e,headers:c,body:n?JSON.stringify(n):void 0,signal:l.signal});if(clearTimeout(u),s.status===200||s.status===202)return await s.json();if(s.status===401)throw new Y("Invalid API key");if(s.status===429)throw new H("Rate limit exceeded");if(s.status===400){let a=await s.json().catch(()=>({}));throw new R(a.message||"Validation error",a.details)}else if(s.status===422){let a=await s.json().catch(()=>({}));throw console.error("[SDK] 422 Validation error - Full details:"),console.error("  Status:",s.status),console.error("  Error data:",JSON.stringify(a,null,2)),console.error("  Message:",a.message),console.error("  Detail:",a.detail),new R(a.message||(typeof a.detail=="string"?a.detail:JSON.stringify(a.detail))||"Validation error",a)}else{let a=await s.json().catch(()=>({}));throw new _(a.message||`API error: ${s.status}`,s.status,a)}}catch(s){throw clearTimeout(u),s instanceof _?s:s instanceof Error&&s.name==="AbortError"?new p(`Request timed out after ${this.timeout} milliseconds`):s instanceof Error?new p(`Request failed: ${s.message}`,s):new p(`Request failed: ${String(s)}`)}}async createCollection(e){let t={name:e.name};e.description&&(t.description=e.description),e.metadata&&(t.metadata=e.metadata);let n=await this._makeRequest("POST","/v1/collections",t),o=n.results||n;return this._collectionFromDict(o)}async getCollection(e){let t=await this._makeRequest("GET",`/v1/collections/${e}`),n=t.results||t;return this._collectionFromDict(n)}async getCollectionByName(e){let t=await this._makeRequest("GET",`/v1/collections/name/${e}`),n=t.results||t;return this._collectionFromDict(n)}async listCollections(e){let t={limit:e?.limit??100,offset:e?.offset??0};e?.name!==void 0&&(t.name=e.name);let n=await this._makeRequest("GET","/v1/collections",void 0,t),o;return typeof n=="object"&&n!==null&&"results"in n?o=n.results:Array.isArray(n)?o=n:o=[n],o.map(i=>this._collectionFromDict(i))}async updateCollection(e){let t={};e.name!==void 0&&(t.name=e.name),e.description!==void 0&&(t.description=e.description),e.metadata!==void 0&&(t.metadata=e.metadata);let n=await this._makeRequest("POST",`/v1/collections/${e.collectionId}`,t),o=n.results||n;return this._collectionFromDict(o)}async deleteCollection(e){return await this._makeRequest("DELETE",`/v1/collections/${e}`),!0}async store(e,t,n={}){let o={...n,memory_type:"memory",timestamp:new Date().toISOString()},i={collection_id:t,raw_text:String(e||""),metadata:o,ingestion_mode:"fast"},c=await this._makeRequest("POST","/v1/memories",i),l=c?.results?.engram_id||c?.results?.id||c?.id||"",u=o.timestamp;return{id:String(l),memory_id:String(l),content:String(e||""),metadata:o,collection_ids:[t],created_at:u,updated_at:u}}async storeMemory(e,t){let n;if("collection_id"in e)n=e;else{let d=e;n={collection_id:d.collection_id||d.collectionId||"",content:d.content||"",role:d.role,memory_id:d.memory_id||d.memoryId||void 0,metadata:d.metadata||{}}}if(n.memory_id)return await this._appendToMemory(n.memory_id,n);if((n.role?"conversation":"document")==="conversation"){let d=[];if(n.content&&n.role){let I=await this._serializeContentAsParts(n.content)??await this._serializeContentAsText(n.content),v=n;d.push({content:I,role:n.role,metadata:n.metadata||{},...typeof v.authority=="number"?{authority:Number(v.authority)}:{}})}if(d.length===0)throw new p("Cannot create conversation without messages. Provide content and role.");let m={collection_id:n.collection_id,name:t||"Conversation",messages:d,metadata:n.metadata||{}},f=await this._makeRequest("POST","/v1/memories",m);if(f.results){let w=f.results.memory_id||f.results.id;if(!w)throw new p("Failed to create conversation: no id returned");return String(w)}throw new p("Failed to create conversation: invalid response format")}let i={...n.metadata};i.memory_type="memory";let c=n;if(typeof c.authority=="number"){let d=Number(c.authority);!Number.isNaN(d)&&d>=0&&d<=1&&(i.authority=d)}let l,u=await this._serializeContentAsParts(n.content);if(u)l={collection_id:n.collection_id,content_parts:u,metadata:i,ingestion_mode:"fast"};else if(Array.isArray(n.content)&&n.content.every(d=>typeof d=="string"))l={collection_id:n.collection_id,chunks:n.content,metadata:i,ingestion_mode:"fast"};else{let d=await this._serializeContentAsText(n.content);if(!d||d==='""'||d==="[]"||d==="{}")throw new p("Content is required for document memories");l={collection_id:n.collection_id,raw_text:d,metadata:i,ingestion_mode:"fast"}}let s=await this._makeRequest("POST","/v1/memories",l),a=s?.results?.engram_id||s?.results?.id||s?.id||"";return String(a||"")}async _appendToMemory(e,t){let n=t.collection_id,o=t.content,i=t.metadata;if(!n)throw new p("collection_id is required");let c={collection_id:n};if(Array.isArray(o))o.length>0&&typeof o[0]=="object"&&"content"in o[0]?c.messages=o:c.chunks=o;else if(typeof o=="string")c.raw_text=o;else throw new p("content must be a string, array of strings, or array of message objects");i&&(c.metadata=i);try{return await this._makeRequest("POST",`/v1/memories/${e}/append`,c),e}catch(l){throw l instanceof _&&l.statusCode===404?new x(e,"Memory"):l}}async storeMemories(e){let t=[],n={},o=[];for(let i of e)if(i.role){let c=i.memory_id||`__new__::${i.collection_id}`;n[c]||(n[c]=[]),n[c].push(i)}else o.push(i);for(let[i,c]of Object.entries(n)){let l=c[0].collection_id,u,s=[];for(let a of c){let m=await this._serializeContentAsParts(a.content)??await this._serializeContentAsText(a.content);if(typeof m=="string"){if(!m.trim())continue}else if(m.length===0)continue;let f=a;s.push({content:m,role:a.role,metadata:a.metadata||{},...typeof f.authority=="number"?{authority:Number(f.authority)}:{}})}if(!s.length)throw new p("Cannot create/append conversation without messages. Provide non-empty content.");if(i.startsWith("__new__::")){let a={collection_id:l,name:"Conversation",messages:s,metadata:{}},d=await this._makeRequest("POST","/v1/memories",a);if(d.results){if(u=d.results.memory_id||d.results.id||"",!u)throw new p("Failed to create conversation: no id returned")}else throw new p("Failed to create conversation: invalid response format")}else{u=i;let a={collection_id:l,content:s,memory_id:u,metadata:{}};await this._appendToMemory(u,a)}t.push(...Array(c.length).fill(String(u)))}for(let i of o)t.push(await this.storeMemory(i));return t}async delete(e){try{if(console.log("[SDK] delete() called with:",{memoryIds:e,type:typeof e,isArray:Array.isArray(e)}),typeof e=="string"){console.log("[SDK] Single deletion path for ID:",e);try{return await this._makeRequest("DELETE",`/v1/memories/${e}`),!0}catch{console.log("[SDK] Falling back to POST /v1/memories/delete with single ID");let t=await this._makeRequest("POST","/v1/memories/delete",e);return typeof t=="object"&&t.success!==void 0?t.success:!0}}else{console.log("[SDK] Batch deletion path for IDs:",e),console.log("[SDK] Sending POST request with body:",e);let t=await this._makeRequest("POST","/v1/memories/delete",e);return console.log("[SDK] Batch deletion response:",t),t}}catch(t){throw console.error("[SDK] Delete error:",t),t instanceof Error?t:new p(`Unknown error: ${String(t)}`)}}async deleteChunk(e){try{return await this._makeRequest("DELETE",`/v1/chunks/${e}`),!0}catch(t){throw t instanceof _&&t.statusCode===404?new x(e,"Chunk"):t}}async updateChunk(e,t,n){let o={content:t};n!==void 0&&(o.metadata=n);try{return await this._makeRequest("PATCH",`/v1/chunks/${e}`,o),!0}catch(i){throw i instanceof _&&i.statusCode===404?new x(e,"Chunk"):i}}async updateMemory(e){let t={};if(e.name!==void 0&&(t.name=e.name),e.metadata!==void 0&&(t.metadata=e.metadata,t.merge_metadata=e.mergeMetadata??!1),e.collectionIds!==void 0&&(t.collection_ids=e.collectionIds),Object.keys(t).length===0)throw new R("At least one field (name, metadata, or collectionIds) must be provided to update");try{return await this._makeRequest("PATCH",`/v1/memories/${e.memoryId}`,t),!0}catch(n){throw n instanceof _&&n.statusCode===404?new x(e.memoryId,"Memory"):n}}async listMemories(e){let t=Array.isArray(e.collection_ids)?e.collection_ids:[e.collection_ids];if(!t.length)throw new p("collection_ids must be provided to list_memories().");let n={limit:e.limit??100,offset:e.offset??0,collection_ids:t};e.metadata_filters&&(n.metadata_filters=JSON.stringify(e.metadata_filters));let o=await this._makeRequest("GET","/v1/memories",void 0,n),i;return typeof o=="object"&&o!==null&&"results"in o?i=o.results:Array.isArray(o)?i=o:i=[o],i.map(c=>this._memoryResponseFromDict(c,t))}async getMemory(e){let t=await this._makeRequest("GET",`/v1/memories/${e}`),n=t.text||t.content,o=Array.isArray(t.chunks)?t.chunks:void 0,i={id:t.id,content:n,chunks:o,metadata:t.metadata||{},collection_ids:t.collection_ids||[]};return this._memoryResponseFromDict(i,[])}async search(e){let t={query:e.query};if(e.effort&&(t.effort=e.effort),e.collection_ids){let l=(Array.isArray(e.collection_ids)?e.collection_ids:[e.collection_ids]).filter(u=>u&&u.trim()!=="");l.length&&(t.collection_ids=l)}e.filters&&(t.filters=e.filters),e.searchSettings&&(t.search_settings=e.searchSettings);let o=(await this._makeRequest("POST","/v1/memories/search",t)).results;return{query:o.query||e.query,entities:o.entities||[],facts:o.facts||[],utterances:o.utterances||[],inference_hints:o.inference_hints||[],fact_to_chunks:o.fact_to_chunks||{},entity_to_facts:o.entity_to_facts||{},retrieved_at:o.retrieved_at||new Date().toISOString(),focus:o.focus,total_traversal_time_ms:o.total_traversal_time_ms,query_intent:o.query_intent}}async healthCheck(){return this._makeRequest("GET","/v1/health")}_collectionFromDict(e){let t;e.created_at&&(typeof e.created_at=="string"?t=e.created_at:e.created_at instanceof Date&&(t=e.created_at.toISOString()));let n;e.updated_at&&(typeof e.updated_at=="string"?n=e.updated_at:e.updated_at instanceof Date&&(n=e.updated_at.toISOString()));let o=String(e.id||""),i=String(e.name||""),c=typeof e.description=="string"?e.description:void 0,l=e.owner_id?String(e.owner_id):void 0,u=typeof e.memory_count=="number"?e.memory_count:0,s={graph_collection_status:String(e.graph_collection_status||""),graph_sync_status:String(e.graph_sync_status||""),user_count:typeof e.user_count=="number"?e.user_count:0};return{id:o,name:i,description:c,metadata:s,created_at:t,updated_at:n,memory_count:u,owner_id:l}}_memoryResponseFromDict(e,t){let n;e.created_at&&(typeof e.created_at=="string"?n=e.created_at:e.created_at instanceof Date&&(n=e.created_at.toISOString()));let o;e.updated_at&&(typeof e.updated_at=="string"?o=e.updated_at:e.updated_at instanceof Date&&(o=e.updated_at.toISOString()));let i=String(e.id||""),c=typeof e.content=="string"?e.content:typeof e.text=="string"?e.text:void 0,l;e.chunks&&Array.isArray(e.chunks)&&(e.chunks.every(a=>typeof a=="string")?l=e.chunks.map(a=>({id:"",content:a,metadata:{}})):l=e.chunks.filter(a=>a&&typeof a=="object"&&("text"in a||"content"in a)).map(a=>({id:String(a.id||""),content:String(a.text||a.content||""),metadata:typeof a.metadata=="object"&&a.metadata!==null?a.metadata:{},role:typeof a.role=="string"?a.role:void 0})));let u={...typeof e.metadata=="object"&&e.metadata!==null?e.metadata:{}};e.engram_id&&(u.engram_id=e.engram_id);let s=i;return e.engram_id&&!i&&(s=String(e.engram_id)),e.document_metadata&&typeof e.document_metadata=="object"&&Object.assign(u,e.document_metadata),{id:s,memory_id:s,content:c,chunks:l,metadata:u,collection_ids:Array.isArray(e.collection_ids)?e.collection_ids:t,created_at:n,updated_at:o}}_searchResultFromDict(e){let t=typeof e.content=="string"?e.content:typeof e.text=="string"?e.text:"",n=String(e.id||e.chunk_id||"");return{id:String(n),content:String(t),score:typeof e.score=="number"?e.score:Number(e.score||0),metadata:typeof e.metadata=="object"&&e.metadata!==null?e.metadata:{},source:typeof e.source=="string"?e.source:void 0}}_searchResultFromGraphDict(e){let t=e.id?String(e.id):"",n=typeof e.result_type=="string"?e.result_type:"entity",o=L[n.toUpperCase()]||"entity",i=typeof e.content=="object"&&e.content!==null?e.content:{},c=e.score!==void 0?Number(e.score):0,l=typeof e.metadata=="object"&&e.metadata!==null?e.metadata:{},u=Array.isArray(e.chunk_ids)?e.chunk_ids:void 0,s;if(e.timestamp)if(typeof e.timestamp=="string")s=e.timestamp;else if(e.timestamp instanceof Date)s=e.timestamp.toISOString();else{let J=new Date(String(e.timestamp));Number.isNaN(J.valueOf())||(s=J.toISOString())}let a=typeof e.display_name=="string"?e.display_name:void 0,d=typeof e.source_role=="string"?e.source_role:void 0,m=e.engram_id?String(e.engram_id):void 0,f=e.owner_id?String(e.owner_id):void 0,w,I,v;return o==="entity"?w={id:i.id?String(i.id):void 0,name:String(i.name||""),description:String(i.description||""),metadata:typeof i.metadata=="object"&&i.metadata!==null?i.metadata:{}}:o==="relationship"?I={id:i.id?String(i.id):void 0,subject:String(i.subject||""),predicate:String(i.predicate||""),object:String(i.object||""),subject_id:i.subject_id?String(i.subject_id):void 0,object_id:i.object_id?String(i.object_id):void 0,description:typeof i.description=="string"?i.description:void 0,metadata:typeof i.metadata=="object"&&i.metadata!==null?i.metadata:{}}:v={id:i.id?String(i.id):void 0,name:String(i.name||""),summary:String(i.summary||""),metadata:typeof i.metadata=="object"&&i.metadata!==null?i.metadata:{}},{id:t,score:c,metadata:l,source:"graph",content:void 0,graph_result_type:o,graph_entity:w,graph_relationship:I,graph_community:v,chunk_ids:u,timestamp:s,display_name:a,source_role:d,engram_id:m,owner_id:f}}async _sha256(e){let t=new TextEncoder().encode(e),n;typeof globalThis.crypto<"u"&&globalThis.crypto.subtle?n=globalThis.crypto:n=(await import("crypto")).webcrypto;let o=await n.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(o)).map(l=>l.toString(16).padStart(2,"0")).join("")}_formDataFromObject(e){let t=new FormData;return Object.entries(e).forEach(([n,o])=>{t.append(n,o)}),t}async _processContentParts(e){let t=[];for(let n of e){if(n.type!=="text"&&n.type!=="s3_ref"&&"data"in n&&n.data){let o=n,i=Math.floor(String(o.data).length*3/4);if(i>W.MAX_INLINE_SIZE){let c=o.filename||"file.bin",l=o.media_type||"application/octet-stream",u=await this.getUploadUrl({filename:c,content_type:l,file_size:i}),s,a=globalThis.atob;if(typeof a=="function"){let d=a(String(o.data));s=new Uint8Array(d.length);for(let m=0;m<d.length;m++)s[m]=d.charCodeAt(m)}else{let{Buffer:d}=await import("buffer");s=Uint8Array.from(d.from(String(o.data),"base64"))}await fetch(u.upload_url,{method:"PUT",body:s,headers:{"Content-Type":l}}),t.push({type:"s3_ref",s3_key:u.s3_key,media_type:l,filename:c});continue}}t.push(n)}return t}async getUploadUrl(e){let t=await this._makeRequest("POST","/v1/memories/upload",void 0,{filename:e.filename,content_type:e.content_type,file_size:e.file_size});return t.results?t.results:t}};V.MAX_INLINE_SIZE=5*1024*1024;var Z=V,Pe={".jpg":"image/jpeg",".jpeg":"image/jpeg",".png":"image/png",".gif":"image/gif",".webp":"image/webp",".heic":"image/heic",".bmp":"image/bmp",".tiff":"image/tiff",".mp3":"audio/mpeg",".wav":"audio/wav",".m4a":"audio/m4a",".ogg":"audio/ogg",".flac":"audio/flac",".aac":"audio/aac",".webm":"audio/webm",".pdf":"application/pdf",".doc":"application/msword",".docx":"application/vnd.openxmlformats-officedocument.wordprocessingml.document",".xls":"application/vnd.ms-excel",".xlsx":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",".ppt":"application/vnd.ms-powerpoint",".pptx":"application/vnd.openxmlformats-officedocument.presentationml.presentation",".txt":"text/plain",".csv":"text/csv",".rtf":"application/rtf",".epub":"application/epub+zip"},$=class{static async fromFile(r,e){let t,n;try{t=await import("fs/promises"),n=await import("path")}catch{throw new Error("File system operations are only supported in Node.js environments.")}let o=n.resolve(r),i=n.basename(o),c=n.extname(o).toLowerCase(),l=e||Pe[c]||"application/octet-stream";return{data:(await t.readFile(o)).toString("base64"),media_type:l,filename:i}}},Oe=r=>r,je=Object.assign(Oe,{File:$.fromFile,async fromFile(r,e,t,n){return{collection_id:e,content:[await $.fromFile(r)],metadata:t||{},role:n}}});y.GraphSearchResultType=L;y.Memory=je;y.Nebula=Z;y.NebulaAuthenticationException=Y;y.NebulaClientException=p;y.NebulaCollectionNotFoundException=Re;y.NebulaContent=$;y.NebulaException=_;y.NebulaNotFoundException=x;y.NebulaRateLimitException=H;y.NebulaValidationException=R;y.default=Z});var ne=g(($t,te)=>{var{Nebula:qe}=X(),A=require("node:fs"),ee=require("node:path"),De=require("node:os"),P=ee.join(De.homedir(),".nebula-claude","collections.json");function Fe(r){if(!r)throw new Error("NEBULA_API_KEY is required");return new qe({apiKey:r})}async function Me(r,e,t){let n=$e();if(n[e])return n[e];let o=t.replace(/[^a-zA-Z0-9-_]/g,"_").toLowerCase();try{let c=(await r.createCollection({name:o})).id;return n[e]=c,Q(n),c}catch(i){if(i.message?.includes("409")||i.message?.includes("exists")){let l=(await r.getCollectionByName(o)).id;return n[e]=l,Q(n),l}throw i}}function $e(){try{if(A.existsSync(P))return JSON.parse(A.readFileSync(P,"utf-8"))}catch{}return{}}function Q(r){let e=ee.dirname(P);A.existsSync(e)||A.mkdirSync(e,{recursive:!0}),A.writeFileSync(P,JSON.stringify(r,null,2))}function Le(r,e=5){let t=r.utterances||[];return t.length===0?null:`<nebula-context>
Relevant memories from previous sessions:

${t.slice(0,e).map(o=>{let i=o.text||"",c=Math.round((o.activation_score||0)*100);return`- ${i.slice(0,200)}${i.length>200?"...":""} [${c}%]`}).join(`
`)}

Use these memories naturally when relevant.
</nebula-context>`}te.exports={createClient:Fe,getOrCreateCollection:Me,formatSearchContext:Le}});var ie=g((Lt,oe)=>{var{execSync:re}=require("node:child_process"),Ue=require("node:crypto");function O(r){return Ue.createHash("sha256").update(r).digest("hex").slice(0,16)}function U(r){try{return re("git rev-parse --show-toplevel",{cwd:r,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim()||null}catch{return null}}function Ke(r){let t=U(r)||r;return`claudecode_project_${O(t)}`}function Be(r){return(U(r)||r).split("/").pop()||"unknown"}function ze(){try{let e=re("git config user.email",{encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim();if(e)return`claudecode_user_${O(e)}`}catch{}let r=process.env.USER||process.env.USERNAME||"anonymous";return`claudecode_user_${O(r)}`}function Je(r,e){return e&&e!=="unknown"?e.replace(/[^a-zA-Z0-9-_]/g,"_").toLowerCase():`project_${r.replace("claudecode_project_","")}`}oe.exports={sha256:O,getGitRoot:U,getContainerTag:Ke,getProjectName:Be,getUserContainerTag:ze,getCollectionName:Je}});var ce=g((Ut,ae)=>{var S=require("node:fs"),se=require("node:path"),Ge=require("node:os"),j=se.join(Ge.homedir(),".nebula-claude"),b=se.join(j,"credentials.json"),Ye=process.env.NEBULA_API_URL||"https://api.trynebula.ai";function He(){S.existsSync(j)||S.mkdirSync(j,{recursive:!0})}function Ve(){try{if(S.existsSync(b)){let r=JSON.parse(S.readFileSync(b,"utf-8"));if(r.apiKey)return r}}catch{}return null}function We(r){He();let e={apiKey:r,savedAt:new Date().toISOString(),apiUrl:Ye};S.writeFileSync(b,JSON.stringify(e,null,2))}function Ze(){try{S.existsSync(b)&&S.unlinkSync(b)}catch{}}async function Xe(r){return!r||typeof r!="string"||r.trim().length===0?{valid:!1,error:"API key must be a non-empty string"}:{valid:!0}}ae.exports={SETTINGS_DIR:j,CREDENTIALS_FILE:b,loadCredentials:Ve,saveCredentials:We,clearCredentials:Ze,validateApiKey:Xe}});var K=g((Kt,de)=>{var E=require("node:fs"),le=require("node:path"),Qe=require("node:os"),{loadCredentials:et}=ce(),q=le.join(Qe.homedir(),".nebula-claude"),N=le.join(q,"settings.json"),ue={skipTools:["Read","Glob","Grep","TodoWrite","AskUserQuestion"],captureTools:["Edit","Write","Bash","Task"],maxProfileItems:5,debug:!1,injectProfile:!0};function tt(){E.existsSync(q)||E.mkdirSync(q,{recursive:!0})}function nt(){let r={...ue};try{if(E.existsSync(N)){let e=E.readFileSync(N,"utf-8");Object.assign(r,JSON.parse(e))}}catch(e){console.error(`Settings: Failed to load ${N}: ${e.message}`)}return process.env.NEBULA_API_KEY&&(r.apiKey=process.env.NEBULA_API_KEY),process.env.NEBULA_SKIP_TOOLS&&(r.skipTools=process.env.NEBULA_SKIP_TOOLS.split(",").map(e=>e.trim())),process.env.NEBULA_DEBUG==="true"&&(r.debug=!0),r}function rt(r){tt();let e={...r};delete e.apiKey,E.writeFileSync(N,JSON.stringify(e,null,2))}function ot(r){if(r.apiKey)return r.apiKey;if(process.env.NEBULA_API_KEY)return process.env.NEBULA_API_KEY;let e=et();if(e?.apiKey)return e.apiKey;throw new Error("NO_API_KEY")}function it(r,e){return e.skipTools.includes(r)?!1:e.captureTools&&e.captureTools.length>0?e.captureTools.includes(r):!0}function st(r,e,t){if(r.debug){let n=new Date().toISOString();console.error(t?`[${n}] ${e}: ${JSON.stringify(t)}`:`[${n}] ${e}`)}}de.exports={SETTINGS_DIR:q,SETTINGS_FILE:N,DEFAULT_SETTINGS:ue,loadSettings:nt,saveSettings:rt,getApiKey:ot,shouldCaptureTool:it,debugLog:st}});var Se=g((Bt,ge)=>{var h=require("node:fs"),C=require("node:path"),me=require("node:os"),D=C.join(me.homedir(),".nebula-claude","trackers"),F=C.join(me.homedir(),".nebula-claude","memory-ids.json");function fe(){h.existsSync(D)||h.mkdirSync(D,{recursive:!0})}function pe(){try{if(h.existsSync(F))return JSON.parse(h.readFileSync(F,"utf-8"))}catch{}return{}}function at(r){let e=C.dirname(F);h.existsSync(e)||h.mkdirSync(e,{recursive:!0}),h.writeFileSync(F,JSON.stringify(r,null,2))}function ct(r){return pe()[r]||null}function lt(r,e){let t=pe();t[r]=e,at(t)}function ye(r){fe();let e=C.join(D,`${r}.txt`);return h.existsSync(e)?h.readFileSync(e,"utf-8").trim():null}function _e(r,e){fe();let t=C.join(D,`${r}.txt`);h.writeFileSync(t,e)}function he(r){return h.existsSync(r)?h.readFileSync(r,"utf-8").trim().split(`
`).filter(t=>t.trim()).map(t=>{try{return JSON.parse(t)}catch{return null}}).filter(Boolean):[]}function B(r){return!r||typeof r!="string"?"":r.replace(/<system-reminder>[\s\S]*?<\/system-reminder>/g,"").replace(/<nebula-context>[\s\S]*?<\/nebula-context>/g,"").trim()}function ut(r){if(!r?.content)return null;let e=r.content;if(typeof e=="string")return B(e)||null;if(!Array.isArray(e))return null;let t=e.filter(n=>n.type==="text"&&n.text).map(n=>B(n.text)).filter(Boolean);return t.length>0?t.join(`

`):null}function dt(r,e){let t=he(r);if(t.length===0)return null;let n=ye(e),o=0;if(n){let u=t.findIndex(s=>s.uuid===n);u>=0&&(o=u+1)}let i=t.slice(o).filter(u=>u.type==="user"||u.type==="assistant");if(i.length===0)return null;let c=i.map(u=>{let s=ut(u.message);return!s||s.length<=10?null:{role:u.type,content:s}}).filter(Boolean);if(c.length===0)return null;let l=i[i.length-1];return _e(e,l.uuid),{messages:c,timestamp:i[0].timestamp||new Date().toISOString()}}ge.exports={extractNewMessages:dt,parseTranscript:he,cleanContent:B,getLastCapturedUuid:ye,setLastCapturedUuid:_e,getNebulaMemoryId:ct,setNebulaMemoryId:lt}});var be=g((zt,we)=>{var{createClient:mt,getOrCreateCollection:ft}=ne(),{getContainerTag:pt,getProjectName:yt}=ie(),{loadSettings:_t,getApiKey:ht,debugLog:k}=K(),{extractNewMessages:gt,getNebulaMemoryId:St,setNebulaMemoryId:wt}=Se();async function bt(r,e,t,n){let o=_t();if(!r||!e)return k(o,`${n}: Missing transcriptPath or sessionId`),{success:!1,count:0};let i;try{i=ht(o)}catch{return k(o,`${n}: No API key configured`),{success:!1,count:0}}let c=gt(r,e);if(!c)return k(o,`${n}: No new content to save`),{success:!0,count:0};try{let l=mt(i),u=pt(t),s=yt(t),a=await ft(l,u,s).catch(()=>u),d=c.messages.map(f=>({role:f.role,content:f.content})),m=St(e);for(let f of d)m?await l.storeMemory({memory_id:m,collection_id:a,content:f.content,role:f.role,metadata:{project:s}}):(m=await l.storeMemory({collection_id:a,content:f.content,role:f.role,metadata:{project:s}}),wt(e,m));return k(o,`${n}: Conversation saved`,{count:c.messages.length}),{success:!0,count:c.messages.length}}catch(l){return k(o,`${n}: Error`,{error:l.message}),{success:!1,count:0,error:l.message}}}we.exports={captureNewMessages:bt}});var xe=g((Jt,ve)=>{async function vt(){return new Promise((r,e)=>{let t="";process.stdin.setEncoding("utf8"),process.stdin.on("data",n=>{t+=n}),process.stdin.on("end",()=>{try{r(t.trim()?JSON.parse(t):{})}catch(n){e(new Error(`Failed to parse stdin JSON: ${n.message}`))}}),process.stdin.on("error",e),process.stdin.isTTY&&r({})})}function M(r){console.log(JSON.stringify(r))}function xt(r=null){M(r?{hookSpecificOutput:{hookEventName:"SessionStart",additionalContext:r}}:{continue:!0,suppressOutput:!0})}function At(r){console.error(`Nebula: ${r}`),M({continue:!0,suppressOutput:!0})}ve.exports={readStdin:vt,writeOutput:M,outputSuccess:xt,outputError:At}});var{captureNewMessages:Nt}=be(),{loadSettings:Et,debugLog:z}=K(),{readStdin:Ct,writeOutput:Ae}=xe();async function kt(){let r=Et();try{let e=await Ct(),{session_id:t,transcript_path:n}=e,o=e.cwd||process.cwd();z(r,"Stop",{sessionId:t,transcriptPath:n});let i=await Nt(n,t,o,"Stop");i.count>0&&z(r,"Stop: Final capture completed",{count:i.count}),Ae({continue:!0})}catch(e){z(r,"Error",{error:e.message}),console.error(`Nebula: ${e.message}`),Ae({continue:!0})}}kt().catch(r=>{console.error(`Nebula fatal: ${r.message}`),process.exit(1)});
